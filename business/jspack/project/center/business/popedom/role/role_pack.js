Ext.namespace('Js.Center.Popedom.RoleAdd');Js.Center.Popedom.RoleAdd.func=function(){var CreateProductUserGroupTree;var PermissionTree;var userGroupList;var departComboxTree=new WXTL.Widgets.CommonForm.ComboWithTree({name:'numdepartid',hiddenName:'numdepartid',fieldLabel:"<font color=red>权限范围</font>",id:'Js.Center.Popedom.RoleAdd.RoleComboxTree',valueField:'id',listHeight:'150',emptyText:'-=请选择=-',allowBlank:false,blankText:'此项必填',baseParams:{columnlist:"numdepartid,vc2departname",flag:'selectallbycurrentuser'},dataUrl:Js.Center.Popedom.DepartmentsQueryURL,listeners:{"select":function(a,b){CreateTree(0,this.getValue());Create_Product_Tree("",this.getValue())}}});var addInfoFormPanel=new Ext.form.FormPanel({frame:true,labelWidth:80,items:[{layout:'column',items:[{xtype:"hidden",name:"flag",value:"insert"},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"92%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",name:"vc2rolename",fieldLabel:"<font color=red>角色名称</font>",allowBlank:false,blankText:"角色名称不允许为空",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",name:"vc2roledesc",fieldLabel:"备注",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]},{columnWidth:1,layout:'form',defaultType:"textfield",defaults:{anchor:"45%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[departComboxTree]},{columnWidth:.5,layout:'form',defaults:{anchor:"90%",msgTarget:"side"},labelWidth:130,bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",fieldLabel:"选择可使用的功能菜单",hidden:true},{html:'<div id="Js.Center.Popedom.RoleAdd.PermitTree" style="float:left;margin:0px;border:1px solid #c3daf9;width:95%;height:270px;"></div>'},{xtype:"hidden",fieldLabel:"功能菜单ID",name:'funpermissionids',id:'Js.Center.Popedom.RoleAdd.FunPermitIds'}]},{columnWidth:.5,layout:'form',defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",labelWidth:130,items:[{xtype:"textfield",fieldLabel:"选择可使用的业务内容",hidden:true},{html:'<div id="Js.Center.Popedom.RoleAdd.product_groupPanel" style="float:left;margin:0px;border:1px solid #c3daf9;width:230px;height:220px;"></div>'},{xtype:"hidden",fieldLabel:"通道组ID",name:'productids',id:'Js.Center.Popedom.RoleAdd.product_list'},{xtype:"hidden",fieldLabel:"客户组ID",name:'usergroupids',id:'Js.Center.Popedom.RoleAdd.user_list'}]}]}]});var mainForm=addInfoFormPanel.getForm();this.window=new WXTL.Widgets.CommonWindows.Window({title:"添加角色",width:'800',mainForm:mainForm,updateURL:Js.Center.Popedom.YXTUserFuncRoleUpdateURL,displayStore:Js.Center.Popedom.Role.Infostore,items:[addInfoFormPanel],needButtons:false,needLoadDataStore:true,buttons:[new Ext.Button({text:'保存退出',minWidth:70,qtip:"保存退出",handler:function(){var idListArr=getAllChildrenNodes(PermissionTree.getRootNode());var ProductIdList=GetProductIdList(CreateProductUserGroupTree);var UserGroupIdList=GetUserGroupIdList(CreateProductUserGroupTree);var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0)idlist+=idListArr[i].id;else idlist+=','+idListArr[i].id}}}Ext.getCmp('Js.Center.Popedom.RoleAdd.product_list').setValue(ProductIdList);Ext.getCmp('Js.Center.Popedom.RoleAdd.user_list').setValue(UserGroupIdList);Ext.getCmp('Js.Center.Popedom.RoleAdd.FunPermitIds').setValue(idlist);if(mainForm.isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Js.Center.Popedom.RoleAdd.window.mainFormSubmitFunc()}}}),new Ext.Button({text:'重填',qtip:"重填",minWidth:70,handler:function(){addInfoFormPanel.getForm().reset();CreateTree(0,Js.Center.Common.userDepartId);Create_Product_Tree("",Js.Center.Common.userDepartId)}}),new Ext.Button({text:'下一步',qtip:"下一步",minWidth:70,handler:function(){var idListArr=getAllChildrenNodes(PermissionTree.getRootNode());var ProductIdList=GetProductIdList(CreateProductUserGroupTree);var UserGroupIdList=GetUserGroupIdList(CreateProductUserGroupTree);var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0)idlist+=idListArr[i].id;else idlist+=','+idListArr[i].id}}}Ext.getCmp('Js.Center.Popedom.RoleAdd.product_list').setValue(ProductIdList);Ext.getCmp('Js.Center.Popedom.RoleAdd.user_list').setValue(UserGroupIdList);Ext.getCmp('Js.Center.Popedom.RoleAdd.FunPermitIds').setValue(idlist);if(mainForm.isValid()){Js.Center.Popedom.RoleAdd.window.mainFormSubmitFunc('Js.Center.Popedom.RoleAdd.nextStepFunc(objJson.roleid, objJson.rolename, objJson.departid,Ext.get("Js.Center.Popedom.RoleAdd.RoleComboxTree").dom.value)')}}}),new Ext.Button({text:'关闭',qtip:"关闭",minWidth:70,handler:function(){Js.Center.Popedom.RoleAdd.window.hide()}})],loadDataStoreFunc:function(){CreateTree(0,Js.Center.Common.userDepartId);Create_Product_Tree("",0)}});var depNode=eval({"id":"s"+Js.Center.Common.userDepartId,"text":Js.Center.Common.userDepartName});function CreateTree(roleId,departId){document.getElementById('Js.Center.Popedom.RoleAdd.PermitTree').innerHTML='';Ext.get('Js.Center.Popedom.RoleAdd.PermitTree').dom.innerHTML='';PermissionTree=new Ext.tree.TreePanel({applyTo:'Js.Center.Popedom.RoleAdd.PermitTree',checkModel:'cascade',onlyLeafCheckable:false,style:'padding:5px 10px 10px 10px',animate:false,rootVisible:false,autoScroll:true,loader:new Ext.tree.TreeLoader({url:Js.Center.Popedom.UserFuncRoleURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={flag:'queryallrightsbyroleid',roleid:roleId,parentid:node.id,departid:departId,method:'POST'}},"load":function(loader,node,response){var childNodes=node.childNodes;if(childNodes&&childNodes.length>0){node.collapse(true)}}},baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI}}),root:new Ext.tree.AsyncTreeNode({id:'-1',text:'无线天利短信发送平台'})});PermissionTree.expandAll();Js.Center.Popedom.RoleAdd.nextStepFunc=function(roleid,rolename,departid,departname){var jsonObject=new Object();jsonObject.success="true";jsonObject.numroleid=roleid;jsonObject.vc2rolename=rolename;jsonObject.numdepartid=departid;jsonObject.vc2departname=departname;Js.Center.Popedom.Role.RolePermit.window.updateRecord=jsonObject;Js.Center.Popedom.Role.RolePermit.window.show()}};function Create_Product_Tree(ProductId,UserGroupId){document.getElementById('Js.Center.Popedom.RoleAdd.product_groupPanel').innerHTML='';Ext.get('Js.Center.Popedom.RoleAdd.product_groupPanel').dom.innerHTML='';CreateProductUserGroupTree=new Ext.tree.TreePanel({applyTo:'Js.Center.Popedom.RoleAdd.product_groupPanel',checkModel:'parentCascade',onlyLeafCheckable:false,style:'padding:5px 10px 0px 10px',animate:false,rootVisible:false,autoScroll:true,listeners:{"checkchange":function(node,checked){var node_length=node.childNodes.length;if(checked==false&&node_length>=1){node.eachChild(function(child){child.ui.toggleCheck(false);child.attributes.checked=false;child.fireEvent('checkchange',child,checked)})}}},loader:new Ext.tree.TreeLoader({url:Js.Center.Business.YXTProductURL,listeners:{"beforeload":function(treeloader,node){Ext.MessageBox.show({msg:'正在加载，请稍等...',progressText:'Loading...',width:300,wait:true,icon:'download',animEl:'saving'});treeloader.baseParams={flag:'selectpermitbydepartidwithroleid',roleid:ProductId,columnlist:'numprodid,vc2name',departid:UserGroupId,method:'POST'}},"load":function(loader,node,response){setTimeout(function(){Ext.MessageBox.hide()},1000);},"loadexception":function(){Ext.MessageBox.hide()}},baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI}}),root:new Ext.tree.AsyncTreeNode({id:'-1',text:'无线天利短信发送平台'}),tbar:[new Ext.form.TextField({width:200,emptyText:'Find a Class',listeners:{render:function(f){f.el.on('keydown',filterTree,f,{buffer:350})}}})]});var hiddenPkgs=[];function filterTree(e){var text=e.target.value;Ext.each(hiddenPkgs,function(n){n.ui.show()});if(!text){filter.clear();return}CreateProductUserGroupTree.expandAll();var re=new RegExp(Ext.escapeRe(text),'i');filter.filterBy(function(n){var textval=n.text;return n.isLeaf()||n.attributes.checked||re.test(n.text)});hiddenPkgs=[];CreateProductUserGroupTree.root.cascade(function(n){if(!n.isLeaf()&&n.ui.ctNode.offsetHeight<3&&!re.test(n.text)){if(!n.attributes.checked){n.ui.hide();hiddenPkgs.push(n)}}if(n.id!='root'){if(!n.isLeaf()&&n.ui.ctNode.offsetHeight>=3&&hasChild(n,re)==false&&!re.test(n.text)){if(!n.attributes.checked){n.ui.hide();hiddenPkgs.push(n)}}}});function hasChild(n,re){var str=false;n.cascade(function(n1){if(re.test(n1.text)){str=true;return}});return str}};var filter=new Ext.tree.TreeFilter(CreateProductUserGroupTree,{clearBlank:true,autoClear:true});CreateProductUserGroupTree.expandAll()};function GetUserGroupIdList(varTree){var idListArr=getAllChildrenNodes(varTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.parentid!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0){idlist+=idListArr[i].id}else{idlist+=','+idListArr[i].id}}}}return idlist};function GetProductIdList(varTree,varWhere){var idListArr=getAllChildrenNodes(varTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].attributes.parentid=='-1'&&idListArr[i].attributes.checked){if(idlist.length==0){idlist+=idListArr[i].id}else{idlist+=','+idListArr[i].id}}}}return idlist}};Ext.namespace('Js.Center.Popedom.RoleDelete');Js.Center.Popedom.RoleDelete.func=function(row){var deleteSplit="";for(var i=0;i<row.length;i++){if(row.length==1){deleteSplit=row[i].data.numroleid}else{if(i<(row.length-1)){deleteSplit=row[i].data.numroleid+","+deleteSplit}if(i==(row.length-1)){deleteSplit=deleteSplit+row[i].data.numroleid}}};var params={ids:deleteSplit,flag:"delete"};doAjax(Js.Center.Popedom.UserFuncRoleUpdateURL,params,Js.Center.Popedom.Role.Infostore)};Ext.namespace('Js.Center.Popedom.Role');Js.Center.Popedom.Role.info=function(node){if(Ext.get("Js.Center.Popedom.Role.MainPanel")==null){roleUpdate=function(rowIndex){var row=roleGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("温馨提示","请您选择一条记录!")}else if(row.length>1){Ext.Msg.alert("温馨提示","对不起，您只能选择一条记录!")}else if(row.length==1){Js.Center.Popedom.RoleUpdate.window.updateRecord=row[0];Js.Center.Popedom.RoleUpdate.window.mainForm.loadRecord(row[0]);Js.Center.Popedom.RoleUpdate.window.show()}};roleDelete=function(rowIndex){var row=roleGrid.getSelectionModel().getSelections();if(row.length>1){Ext.Msg.alert("提示信息","您只能选择一个删除!")}else if(row.length==1){Ext.Msg.confirm("提示!","您确定要删除信息吗?",function(btn){if(btn=="yes"){Js.Center.Popedom.RoleDelete.func(row)}else{}})}};roleArrayDelete=function(){var row=roleGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("提示信息","请您至少选择一个!")}else{Ext.Msg.confirm("提示!","您确定要删除信息吗?",function(btn){if(btn=="yes"){Js.Center.Popedom.RoleDelete.func(row)}else{}})}};rolePermit=function(){Js.Center.Popedom.Role.RolePermit.window.updateRecord=null;Js.Center.Popedom.Role.RolePermit.window.show();};rolePermitToUser=function(){var row=roleGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("温馨提示","请您选择一条记录!")}else if(row.length>1){Ext.Msg.alert("温馨提示","对不起，您只能选择一条记录!")}else if(row.length==1){Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord=row[0];Js.Center.Popedom.Role.RolePermitToUser.window.mainForm.loadRecord(row[0]);Js.Center.Popedom.Role.RolePermitToUser.window.show()}};rolePermitToDepart=function(){var row=roleGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("温馨提示","请您选择一条记录!")}else if(row.length>1){Ext.Msg.alert("温馨提示","对不起，您只能选择一条记录!")}else if(row.length==1){Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord=row[0];Js.Center.Popedom.Role.RolePermitToDepart.window.mainForm.loadRecord(row[0]);Js.Center.Popedom.Role.RolePermitToDepart.window.show()}};var _pageSize=12;var fields=["numroleid","vc2rolename","numdepartid","vc2departname","vc2roledesc","numrolestate","numcreator","vc2creatorname","datcreatetime","numlastmodifyuser","vc2lastmodifyname","datlastmodifytime","departcount","usercount"];Js.Center.Popedom.Role.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserFuncRoleURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:fields,root:"data",id:"numroleid",totalProperty:"totalCount"}),sortInfo:{field:'datcreatetime',direction:'DESC'},baseParams:{rolename:'',departid:'',limit:_pageSize,flag:'selectbykey'}});Js.Center.Popedom.Role.Infostore.load({params:{start:0,limit:_pageSize,rolename:'',departid:'',flag:'selectbykey'}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numroleid"});var cm=new Ext.grid.ColumnModel([sm,{header:"序号",tooltip:"序号",dataIndex:"numroleid",sortable:true},{header:"角色名称",tooltip:"角色名称",dataIndex:"vc2rolename",sortable:true},{header:"创建部门",tooltip:"创建部门",dataIndex:"vc2departname",sortable:true},{header:"创建者",tooltip:"创建者",dataIndex:"vc2creatorname",sortable:true},{header:"创建时间",tooltip:"创建时间",dataIndex:"datcreatetime",sortable:true},{header:"修改人",tooltip:"修改人",dataIndex:"vc2lastmodifyname",sortable:true},{header:"修改时间",tooltip:"修改时间",dataIndex:"datlastmodifytime",sortable:true},{header:"备注",tooltip:"备注",dataIndex:"vc2roledesc",sortable:true},{header:"授权账户",tooltip:"授权账户",dataIndex:"usercount",renderer:function(value,meta,record,rowIndex,colIndex,store){return"&nbsp;&nbsp;<a href='#' onclick='rolePermitToUser()'>授权</a>　"}},{header:"授权部门",tooltip:"授权部门",dataIndex:"departcount",renderer:function(value,meta,record,rowIndex,colIndex,store){return"&nbsp;&nbsp;<a href='#' onclick='rolePermitToDepart()'>授权</a>　"}},{header:"角色操作",tooltip:"角色操作",dataIndex:"numroleid",renderer:function(value,meta,record,rowIndex,colIndex,store){return"<a href='#' onclick='roleUpdate(\""+rowIndex+"\")'>修改</a>　<a href='#' onclick='roleDelete(\""+rowIndex+"\")'>删除</a>"}}]);var RolearrInitLoadFunc=new Array();RolearrInitLoadFunc[0]="Js.Center.Popedom.Role.RolePermitToUser.func";RolearrInitLoadFunc[1]="Js.Center.Popedom.Role.RolePermitToDepart.func";RolearrInitLoadFunc[2]="Js.Center.Popedom.Role.RolePermit.func";var roleGrid=new WXTL.Widgets.CommonGrid.GridPanel({anchor:'100% 100%',pageSize:_pageSize,needMenu:false,needRightMenu:false,store:Js.Center.Popedom.Role.Infostore,afterEditURL:Js.Center.Popedom.UserFuncRoleUpdateURL,inertMethod:'Js.Center.Popedom.RoleAdd',updateMethod:'Js.Center.Popedom.RoleUpdate',deleteMethod:'Js.Center.Popedom.RoleDelete.func',otherInitLoadFunc:RolearrInitLoadFunc,sm:sm,cm:cm,tbar:new Ext.Toolbar({items:[{iconCls:'addicon',text:"添加角色",tooltip:"添加角色",handler:function(){roleGrid.doInsert()}},"","-","",{text:"角色授权",tooltip:"角色授权",iconCls:"editicon",handler:function(){rolePermit()}},"","-","",{text:"删除",tooltip:"删除",iconCls:"deleteicon",handler:function(){roleGrid.doDelete()}}]})});var departComboxTree=new WXTL.Widgets.CommonForm.ComboWithTree({name:'numdepartid',hiddenName:'numdepartid',id:'Js.Center.Popedom.RoleInfo.departComboxTree',fieldLabel:"部门名称",valueField:'id',listHeight:'150',baseParams:{columnlist:"numdepartid,vc2departname",flag:'selectallbycurrentuser'},dataUrl:Js.Center.Popedom.DepartmentsQueryURL});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({id:"Js.Center.Popedom.Role.selectPanel",height:100,queryMethod:"Js.Center.Popedom.Role.queryGrid",items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{fieldLabel:'角色名称',name:'rolename',id:'Js.Center.Popedom.Role.RoleName',regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[departComboxTree]}]}]});Js.Center.Popedom.Role.queryGrid=function(){if(selectPanel.getForm().isValid()){var _roleName=Ext.get("Js.Center.Popedom.Role.RoleName").getValue();var _departId=departComboxTree.getValue()==null?"":departComboxTree.getValue().replace("s","");var _flag='selectbykey';Js.Center.Popedom.Role.Infostore.baseParams={rolename:_roleName,departid:_departId,flag:_flag};Js.Center.Popedom.Role.Infostore.load({params:{start:0,limit:_pageSize,rolename:_roleName,departid:_departId,flag:_flag}})}};Js.Center.Popedom.Role.MainPanel=new Ext.Panel({frame:true,id:"Js.Center.Popedom.Role.MainPanel",bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[selectPanel,roleGrid]})};GridMain(node,Js.Center.Popedom.Role.MainPanel,"openroomiconinfo","Js.Center.Popedom.Role.Infostore")};Ext.namespace('Js.Center.Popedom.Role.RolePermit');Js.Center.Popedom.Role.RolePermit.func=function(roleId,roleName,departId,departName){if(Js.Center.Popedom.Role.RolePermit.window==null){var _roleIds;var roleCombo=new Ext.form.ComboBox({fieldLabel:"角色名称",hiddenName:"numroleid",name:"numroleid",id:'Js.Center.Popedom.Role.RolePermit.roleCombo',readOnly:true,mode:"local",displayField:"vc2rolename",valueField:"numroleid",triggerAction:"all",emptyText:"请选择角色",allowBlank:false,blankText:'请选择角色',store:Js.Center.Common.RoleByDepartIdStore,listeners:{"select":function(value){southPanel.collapse(true);_roleIds=this.getValue();fromStoreUser.load({params:{roleid:this.getValue(),departid:departComboxTree.getValue()}});toStoreUser.load({params:{roleid:this.getValue(),departid:departComboxTree.getValue()}});fromStoreDepart.load({params:{roleid:this.getValue(),parentid:departComboxTree.getValue()}});toStoreDepart.load({params:{roleid:this.getValue(),parentid:departComboxTree.getValue()}})}}});var departComboxTree=new WXTL.Widgets.CommonForm.ComboWithTree({name:'numdepartid',hiddenName:'numdepartid',fieldLabel:"部门名称",allowBlank:false,blankText:'请选择部门',valueField:'id',listWidth:'200',listHeight:'150',baseParams:{columnlist:"numdepartid,vc2departname",flag:'selectallbycurrentuser'},dataUrl:Js.Center.Popedom.DepartmentsQueryURL,listeners:{"select":function(a,b){southPanel.collapse(true);roleCombo.setValue('');Js.Center.Common.RoleByDepartIdStore.load({params:{departid:b.id}});fromStoreUser.load({params:{roleid:'',departid:b.id}});toStoreUser.load({params:{roleid:'',departid:b.id}});fromStoreDepart.load({params:{roleid:'',parentid:b.id}});toStoreDepart.load({params:{roleid:'',parentid:b.id}})}}});var departComboxTreePanl=new Ext.Panel({width:'95%',items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[departComboxTree]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[roleCombo]}]}]});var permissionDepartmentPanl=new Ext.form.FormPanel({frame:true,autoScroll:true,padding:'10 10 10 10',items:[departComboxTreePanl]});var fromStoreUser=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numuserid","vc2username"],root:'data',id:'numuserid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numuserid,vc2username",typeid:0}});var toStoreUser=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numuserid","vc2username"],root:'data',id:'numuserid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numuserid,vc2username",typeid:1}});var fromStoreDepart=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.DepartmentsQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numdepartid","vc2departname"],root:'data',id:'numdepartid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numdepartid,vc2departname",typeid:0}});var toStoreDepart=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.DepartmentsQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numdepartid","vc2departname"],root:'data',id:'numdepartid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numdepartid,vc2departname",typeid:1}});var PermissionTreeToUser=new Ext.form.FormPanel({frame:true,bodyStyle:'padding:10px,0px,0px,10px',autoScroll:true,labelWidth:60,items:[{anchor:',100%',xtype:"itemselector",name:"itemselector",fieldLabel:"配置账户",dataFields:["numuserid","vc2username"],toData:[""],msWidth:250,autoScroll:true,enableDD:false,msHeight:130,valueField:'numuserid',displayField:'vc2username',toLegend:"已选择用户",fromLegend:"可选择用户",fromStore:fromStoreUser,toStore:toStoreUser,listeners:{"change":function(){southPanel.collapse(true)}}}]});var PermissionTreeToDepart=new Ext.form.FormPanel({frame:true,bodyStyle:'padding:10px,0px,0px,10px',autoScroll:true,labelWidth:60,items:[{anchor:',100%',xtype:"itemselector",name:"itemselector",id:"Js.Center.Role.RolePermit.itemselector",fieldLabel:"配置部门",dataFields:["numdepartid","vc2departname"],toData:[""],msWidth:250,autoScroll:true,enableDD:false,msHeight:130,valueField:'numdepartid',displayField:'vc2departname',toLegend:"已使用的部门",fromLegend:"待选择的部门",fromStore:fromStoreDepart,toStore:toStoreDepart,fromTBar:[new Ext.form.TextField({width:200,id:"Js.Center.Role.Permit.Textsearch",emptyText:'Find a Class',listeners:{render:function(f){f.el.on('keyup',function(e){Ext.getCmp("Js.Center.Role.RolePermit.itemselector").fromMultiselect.view.store.filter("vc2departname",f.getValue(),true,false)},f,{buffer:350})}}})],listeners:{"change":function(){southPanel.collapse(true)}}}]});var hiddenPkgs=[];function filterData(e){alert(2);fromStoreDepart.filterBy(function(n){alert(1);var text=record.get('vc2departname');})}var permissionRolePanel=new Ext.Panel({frame:true,height:350,items:[PermissionTreeToUser,PermissionTreeToDepart]});var ProductStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Business.RoleProductURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numprodid","vc2name"],root:'data',id:'numprodid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numprodid,vc2name",roleids:''}});var UserGroupStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserFuncRoleURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numusergroupid","vc2usergroupname"],root:'data',id:'numusergroupid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numusergroupid,vc2usergroupname",roleids:''}});var treePanel=new Ext.tree.TreePanel({border:false,applyTo:'',root:new Ext.tree.AsyncTreeNode({id:"-1",text:"功能权限",loader:new Ext.tree.TreeLoader({url:Js.Center.Popedom.UserFuncRoleURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={parentid:node.id,flag:'selectfuncpermitbyroleids',roleids:_roleIds,method:'POST'}}}})}),rootVisible:true});var southPanel=new Ext.form.FormPanel({title:'部门功能汇集列表',width:'100%',id:"Js.Center.Popedom.Role.RolePermit.southPanel",collapsible:true,collapsed:true,autoScroll:true,border:true,frame:true,items:[{layout:'column',items:[{columnWidth:.3,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[treePanel]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"productlist",id:'Js.Center.Popedom.Role.RolePermit.ProductList',fieldLabel:"通道组列表",height:200,disabled:true}]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"usergrouplist",id:'Js.Center.Popedom.Role.RolePermit.UserGroupList',fieldLabel:"客户组列表",height:200,disabled:true}]}]}],listeners:{"expand":function(a,b,c){if(_roleIds==null){Ext.Msg.alert("温馨提示","请先选择角色!")}else{treePanel.root.reload();var userUgoupNames="";var productNames="";var roleID=roleCombo.getValue();if(roleId!=null){roleID=roleId}var jsonProductList=eval(doSynRequest(Js.Center.Business.RoleProductURL+"?flag=selectpermitbyroleids&columnlist=numprodid,vc2name&roleids="+roleID));if(jsonProductList.data.length>0){for(var i=0;i<jsonProductList.data.length;i++){if(jsonProductList.data.length==1){productNames=jsonProductList.data[i].vc2name}else{if(i<(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name+","}if(i==(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name}}}}else{productNames="没有已授权的通道组！"}a.items.items[0].items.items[1].items.items[0].setValue(productNames);var jsonUserGroupList=eval(doSynRequest(Js.Center.Business.UserGroupURL+"?flag=selectpermitbyroleids&columnlist=numusergroupid,vc2usergroupname&roleids="+roleID));if(jsonUserGroupList.data.length>0){for(var i=0;i<jsonUserGroupList.data.length;i++){if(jsonUserGroupList.data.length==1){userUgoupNames=jsonUserGroupList.data[i].vc2usergroupname}else{if(i<(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname+","}if(i==(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname}}}}else{userUgoupNames="没有已授权的客户组！"}a.items.items[0].items.items[2].items.items[0].setValue(userUgoupNames)}}}});var mainForm=permissionDepartmentPanl.getForm();this.window=new WXTL.Widgets.CommonWindows.Window({title:"角色授权",mainForm:mainForm,width:680,height:500,autoScroll:true,displayStore:Js.Center.Popedom.Role.Infostore,needButtons:false,updateState:true,items:[permissionDepartmentPanl,permissionRolePanel,southPanel],needLoadDataStore:true,loadDataStoreFunc:function(){departComboxTree.tree.root.reload();Ext.getCmp('Js.Center.Role.Permit.Textsearch').enable();Ext.getCmp('Js.Center.Role.Permit.Textsearch').setValue(null);Js.Center.Common.RoleByDepartIdStore.load({params:{departid:''}});_roleIds=null;if(Js.Center.Popedom.Role.RolePermit.window.updateRecord!=null&&Js.Center.Popedom.Role.RolePermit.window.updateRecord!=""){var node;if(Js.Center.Popedom.Role.RolePermit.window.updateRecord.success==null){node={'id':Js.Center.Popedom.Role.RolePermit.window.updateRecord.get("numdepartid"),'text':Js.Center.Popedom.Role.RolePermit.window.updateRecord.get("vc2departname")};roleCombo.setValue(Js.Center.Popedom.Role.RolePermit.window.updateRecord.get("numroleid"));_roleIds=Js.Center.Popedom.Role.RolePermit.window.updateRecord.get("numroleid");Ext.get("Js.Center.Popedom.Role.RolePermit.roleCombo").dom.value=Js.Center.Popedom.Role.RolePermit.window.updateRecord.vc2rolename}else{node={'id':Js.Center.Popedom.Role.RolePermit.window.updateRecord.numdepartid,'text':Js.Center.Popedom.Role.RolePermit.window.updateRecord.vc2departname};roleCombo.setValue(Js.Center.Popedom.Role.RolePermit.window.updateRecord.numroleid);_roleIds=Js.Center.Popedom.Role.RolePermit.window.updateRecord.numroleid;Ext.get("Js.Center.Popedom.Role.RolePermit.roleCombo").dom.value=Js.Center.Popedom.Role.RolePermit.window.updateRecord.vc2rolename}departComboxTree.setValue(node);departComboxTree.disable();roleCombo.disable()}else{departComboxTree.enable();roleCombo.enable()}fromStoreUser.load({params:{roleid:roleCombo.getValue(),parentid:departComboxTree.getValue()}});toStoreUser.load({params:{roleid:roleCombo.getValue(),parentid:departComboxTree.getValue()}});fromStoreDepart.load({params:{roleid:roleCombo.getValue(),parentid:departComboxTree.getValue()}});toStoreDepart.load({params:{roleid:roleCombo.getValue(),parentid:departComboxTree.getValue()}})},buttons:[{text:'保存',handler:function(){if(mainForm.isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,waitConfig:{interval:200},icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Ext.getCmp('Js.Center.Role.Permit.Textsearch').disable();updateRolePermitUserDepart(WXTL.Common.urlDecode(PermissionTreeToUser.getForm().getValues(true)).replace('itemselector=',''),WXTL.Common.urlDecode(PermissionTreeToDepart.getForm().getValues(true)).replace('itemselector=',''))}}},{text:"取 消",minWidth:70,handler:function(){Js.Center.Popedom.Role.RolePermit.window.mainForm.reset();Js.Center.Popedom.Role.RolePermit.window.hide()}}]});function updateRolePermitUserDepart(userIdList,departIdList){var _roleID=roleCombo.getValue();var _departID=departComboxTree.getValue();if(roleId!=null){_roleID=roleId};if(departId!=null){_departID=departId};var params={flag:'updatedepartuserrightbyroleid',roleid:_roleID,bigdepartid:_departID,selectdepartid:departIdList,selectuserid:userIdList};Js.Center.Popedom.Role.RolePermit.window.mainFormSubmitFunc('',params,Js.Center.Popedom.UserFuncRoleUpdateURL)}}};Ext.namespace('Js.Center.Popedom.Role.RolePermitToDepart');Js.Center.Popedom.Role.RolePermitToDepart.func=function(row){if(Js.Center.Popedom.Role.RolePermitToDepart.window==null){var departComboxTreePanl=new Ext.Panel({width:'95%',items:[{labelWidth:60,layout:'column',items:[{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"hidden",name:"roleid",fieldLabel:"角色ID"},{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2rolename",fieldLabel:"角色名称"}]},{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"hidden",name:"numdepartid",fieldLabel:"所属部门ID"},{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2departname",fieldLabel:"所属部门"}]},{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2roledesc",fieldLabel:"备注"}]}]}]});var permissionDepartmentPanl=new Ext.form.FormPanel({frame:true,autoScroll:true,padding:'10 10 10 10',items:[departComboxTreePanl]});var fromStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.DepartmentsQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numdepartid","vc2departname"],root:'data',id:'numdepartid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numdepartid,vc2departname",typeid:0}});var toStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.DepartmentsQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numdepartid","vc2departname"],root:'data',id:'numdepartid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numdepartid,vc2departname",typeid:1}});var PermissionTree=new Ext.form.FormPanel({frame:true,bodyStyle:'padding:10px,0px,0px,10px',autoScroll:true,labelWidth:60,items:[{anchor:',100%',xtype:"itemselector",name:"itemselector",fieldLabel:"配置部门",dataFields:["numdepartid","vc2departname"],toData:[""],msWidth:250,autoScroll:true,enableDD:false,msHeight:200,valueField:'numdepartid',displayField:'vc2departname',toLegend:"已使用的部门",fromLegend:"待选择的部门",fromStore:fromStore,toStore:toStore,listeners:{"change":function(){southPanel.collapse(true)}}}]});var permissionRolePanel=new Ext.Panel({frame:true,height:240,items:[PermissionTree]});var ProductStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Business.RoleProductURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numprodid","vc2name"],root:'data',id:'numprodid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numprodid,vc2name",roleids:''}});var UserGroupStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserFuncRoleURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numusergroupid","vc2usergroupname"],root:'data',id:'numusergroupid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numusergroupid,vc2usergroupname",roleids:''}});var treePanel=new Ext.tree.TreePanel({border:false,applyTo:'',root:new Ext.tree.AsyncTreeNode({id:"-1",text:"功能权限",loader:new Ext.tree.TreeLoader({url:Js.Center.Popedom.UserFuncRoleURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={parentid:node.id,flag:'selectfuncpermitbyroleids',roleids:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid"),method:'POST'}}}})}),rootVisible:true});var southPanel=new Ext.form.FormPanel({title:'本角色功能汇集列表',width:'100%',id:"Js.Center.Popedom.Role.RolePermitToDepart.southPanel",collapsible:true,collapsed:true,autoScroll:true,border:true,frame:true,items:[{layout:'column',items:[{columnWidth:.3,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[treePanel]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"productlist",id:'Js.Center.Popedom.Role.RolePermitToDepart.ProductList',fieldLabel:"通道组列表",height:200,disabled:true}]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"usergrouplist",id:'Js.Center.Popedom.Role.RolePermitToDepart.UserGroupList',fieldLabel:"客户组列表",height:200,disabled:true}]}]}],listeners:{"expand":function(a,b,c){treePanel.root.reload();var userUgoupNames="";var productNames="";var jsonProductList=eval(doSynRequest(Js.Center.Business.RoleProductURL+"?flag=selectpermitbyroleids&columnlist=numprodid,vc2name&roleids="+Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid")));if(jsonProductList.data.length>0){for(var i=0;i<jsonProductList.data.length;i++){if(jsonProductList.data.length==1){productNames=jsonProductList.data[i].vc2name}else{if(i<(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name+","}if(i==(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name}}}}else{productNames="没有已授权的通道组！"}a.items.items[0].items.items[1].items.items[0].setValue(productNames);var jsonUserGroupList=eval(doSynRequest(Js.Center.Business.UserGroupURL+"?flag=selectpermitbyroleids&columnlist=numusergroupid,vc2usergroupname&roleids="+Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid")));if(jsonUserGroupList.data.length>0){for(var i=0;i<jsonUserGroupList.data.length;i++){if(jsonUserGroupList.data.length==1){userUgoupNames=jsonUserGroupList.data[i].vc2usergroupname}else{if(i<(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname+","}if(i==(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname}}}}else{userUgoupNames="没有已授权的客户组！"}a.items.items[0].items.items[2].items.items[0].setValue(userUgoupNames)}}});var mainForm=permissionDepartmentPanl.getForm();this.window=new WXTL.Widgets.CommonWindows.Window({title:"配置部门角色",mainForm:mainForm,width:680,height:400,autoScroll:true,displayStore:Js.Center.Popedom.Role.Infostore,needButtons:false,updateState:true,updateRecord:row,needLoadDataStore:true,items:[permissionDepartmentPanl,permissionRolePanel,southPanel],buttons:[{text:'保存',handler:function(){if(mainForm.isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,waitConfig:{interval:200},icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var params={flag:'updatedepartrightbyroleid',roleid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid"),bigdepartid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numdepartid"),selectdepartid:WXTL.Common.urlDecode(PermissionTree.getForm().getValues(true)).replace('itemselector=','')};Js.Center.Popedom.Role.RolePermitToDepart.window.mainFormSubmitFunc('',params,Js.Center.Popedom.UserFuncRoleUpdateURL)}}},{text:"取 消",minWidth:70,handler:function(){Js.Center.Popedom.Role.RolePermitToDepart.window.hide()}}],loadDataStoreFunc:function(){fromStore.load({params:{roleid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid"),parentid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numdepartid")}});toStore.load({params:{roleid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numroleid"),parentid:Js.Center.Popedom.Role.RolePermitToDepart.window.updateRecord.get("numdepartid")}})}});}};Ext.namespace('Js.Center.Popedom.Role.RolePermitToUser');Js.Center.Popedom.Role.RolePermitToUser.func=function(row){if(Js.Center.Popedom.Role.RolePermitToUser.window==null){var departComboxTreePanl=new Ext.Panel({width:'95%',items:[{labelWidth:60,layout:'column',items:[{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"hidden",name:"roleid",fieldLabel:"角色ID"},{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2rolename",fieldLabel:"角色名称"}]},{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"hidden",name:"numdepartid",fieldLabel:"所属部门ID"},{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2departname",fieldLabel:"所属部门"}]},{columnWidth:.33,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{labelWidth:45,readOnly:true,xtype:"textfield",name:"vc2roledesc",fieldLabel:"备注"}]}]}]});var permissionDepartmentPanl=new Ext.form.FormPanel({frame:true,autoScroll:true,padding:'10 10 10 10',items:[departComboxTreePanl]});var mainForm=permissionDepartmentPanl.getForm();var fromStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numuserid","vc2username"],root:'data',id:'numuserid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numuserid,vc2username",typeid:0}});var toStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numuserid","vc2username"],root:'data',id:'numuserid'}),baseParams:{flag:"selectbydepartidwithroleid",columnlist:"numuserid,vc2username",typeid:1}});var PermissionTree=new Ext.form.FormPanel({frame:true,bodyStyle:'padding:10px,0px,0px,10px',autoScroll:true,labelWidth:60,items:[{anchor:',100%',xtype:"itemselector",id:"Js.Center.RolePermitToUser.itemselector",name:"itemselector",fieldLabel:"配置账户",dataFields:["numuserid","vc2username"],toData:[""],msWidth:250,autoScroll:true,enableDD:false,msHeight:200,valueField:'numuserid',displayField:'vc2username',toLegend:"已选择用户",fromLegend:"可选择用户",fromStore:fromStore,toStore:toStore,fromTBar:[new Ext.form.TextField({width:200,id:"Js.Center.Role.PermitToUser.Textsearch",emptyText:'Find a Class',listeners:{render:function(f){f.el.on('keyup',function(e){Ext.getCmp("Js.Center.RolePermitToUser.itemselector").fromMultiselect.view.store.filter("vc2username",f.getValue(),true,false)},f,{buffer:350})}}})],listeners:{"change":function(){southPanel.collapse(true)}}}]});var permissionRolePanel=new Ext.Panel({frame:true,height:240,items:[PermissionTree]});var ProductStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Business.RoleProductURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numprodid","vc2name"],root:'data',id:'numprodid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numprodid,vc2name",roleids:''}});var UserGroupStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:Js.Center.Popedom.UserFuncRoleURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numusergroupid","vc2usergroupname"],root:'data',id:'numusergroupid'}),baseParams:{flag:"selectpermitbyroleids",columnlist:"numusergroupid,vc2usergroupname",roleids:''}});var treePanel=new Ext.tree.TreePanel({border:false,applyTo:'',root:new Ext.tree.AsyncTreeNode({id:"-1",text:"功能权限",loader:new Ext.tree.TreeLoader({url:Js.Center.Popedom.UserFuncRoleURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={parentid:node.id,flag:'selectfuncpermitbyroleids',roleids:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid"),method:'POST'}}}})}),rootVisible:true});var southPanel=new Ext.form.FormPanel({title:'本角色功能汇集列表',width:'100%',id:"Js.Center.Popedom.Role.RolePermitToUser.southPanel",collapsible:true,collapsed:true,autoScroll:true,border:true,frame:true,items:[{layout:'column',items:[{columnWidth:.3,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[treePanel]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"productlist",id:'Js.Center.Popedom.Role.RolePermitToUser.ProductList',fieldLabel:"通道组列表",height:200,disabled:true}]},{columnWidth:.35,layout:'form',labelWidth:65,defaultType:"textfield",defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[{xtype:"textarea",name:"usergrouplist",id:'Js.Center.Popedom.Role.RolePermitToUser.UserGroupList',fieldLabel:"客户组列表",height:200,disabled:true}]}]}],listeners:{"expand":function(a,b,c){treePanel.root.reload();var userUgoupNames="";var productNames="";var jsonProductList=eval(doSynRequest(Js.Center.Business.RoleProductURL+"?flag=selectpermitbyroleids&columnlist=numprodid,vc2name&roleids="+Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid")));if(jsonProductList.data.length>0){for(var i=0;i<jsonProductList.data.length;i++){if(jsonProductList.data.length==1){productNames=jsonProductList.data[i].vc2name}else{if(i<(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name+","}if(i==(jsonProductList.data.length-1)){productNames+=jsonProductList.data[i].vc2name}}}}else{productNames="没有已授权的通道组！"}a.items.items[0].items.items[1].items.items[0].setValue(productNames);var jsonUserGroupList=eval(doSynRequest(Js.Center.Business.UserGroupURL+"?flag=selectpermitbyroleids&columnlist=numusergroupid,vc2usergroupname&roleids="+Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid")));if(jsonUserGroupList.data.length>0){for(var i=0;i<jsonUserGroupList.data.length;i++){if(jsonUserGroupList.data.length==1){userUgoupNames=jsonUserGroupList.data[i].vc2usergroupname}else{if(i<(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname+","}if(i==(jsonUserGroupList.data.length-1)){userUgoupNames+=jsonUserGroupList.data[i].vc2usergroupname}}}}else{userUgoupNames="没有已授权的客户组！"}a.items.items[0].items.items[2].items.items[0].setValue(userUgoupNames)}}});this.window=new WXTL.Widgets.CommonWindows.Window({title:"配置角色使用用户",mainForm:mainForm,width:680,height:400,updateState:true,updateRecord:row,autoScroll:true,displayStore:Js.Center.Popedom.Role.Infostore,needButtons:false,needLoadDataStore:true,items:[permissionDepartmentPanl,permissionRolePanel,southPanel],buttons:[{text:'保存',handler:function(){if(mainForm.isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,waitConfig:{interval:200},icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Ext.getCmp('Js.Center.Role.PermitToUser.Textsearch').disable();var params={flag:'updateuserrightbyroleid',roleid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid"),bigdepartid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numdepartid"),selectuserid:WXTL.Common.urlDecode(PermissionTree.getForm().getValues(true)).replace('itemselector=','')};Js.Center.Popedom.Role.RolePermitToUser.window.mainFormSubmitFunc('',params,Js.Center.Popedom.UserFuncRoleUpdateURL);}}},{text:"取 消",minWidth:70,handler:function(){Js.Center.Popedom.Role.RolePermitToUser.window.hide()}}],loadDataStoreFunc:function(){Ext.getCmp('Js.Center.Role.PermitToUser.Textsearch').enable();Ext.getCmp('Js.Center.Role.PermitToUser.Textsearch').setValue(null);fromStore.load({params:{roleid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid"),departid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numdepartid")}});toStore.load({params:{roleid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numroleid"),departid:Js.Center.Popedom.Role.RolePermitToUser.window.updateRecord.get("numdepartid")}})}});}};Ext.namespace('Js.Center.Popedom.RoleUpdate');Js.Center.Popedom.RoleUpdate.func=function(row){var CreateProductUserGroupTree;var PermissionTree;var userGroupList;var departComboxTree=new WXTL.Widgets.CommonForm.ComboWithTree({name:'numdepartid',hiddenName:'vc2departname',id:"Js.Center.Popedom.RoleUpdate.departComboxTree",fieldLabel:"<font color=red>权限范围</font>",valueField:'id',listWidth:'200',listHeight:'150',baseParams:{columnlist:"numdepartid,vc2departname",flag:'selectallbycurrentuser'},dataUrl:Js.Center.Popedom.DepartmentsQueryURL});var updateInfoFormPanel=new Ext.form.FormPanel({frame:true,labelWidth:80,items:[{layout:'column',items:[{xtype:"hidden",name:"flag",value:'updateall'},{xtype:"hidden",name:"numroleid",fieldLabel:"编号"},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",name:"vc2rolename",fieldLabel:"<font color=red>角色名称</font>",allowBlank:false,blankText:"角色名称不允许为空",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",name:"vc2roledesc",fieldLabel:"备注",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]},{columnWidth:1,layout:'form',defaultType:"textfield",defaults:{anchor:"44%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"hidden",name:"numdepartid",fieldLabel:"<font color=red>部门ID</font>"},{xtype:"textfield",name:"vc2departname",fieldLabel:"<font color=red>权限范围</font>",readOnly:true}]},{columnWidth:.5,layout:'form',defaults:{anchor:"90%",msgTarget:"side"},labelWidth:130,bodyStyle:"padding:0px 0 0px 15px",items:[{xtype:"textfield",fieldLabel:"选择可使用的功能菜单",hidden:true},{html:'<div id="Js.Center.Popedom.RoleUpdate.PermitTree" style="float:left;margin:0px;border:1px solid #c3daf9;width:96%;height:278px;"></div>'},{xtype:"hidden",fieldLabel:"功能菜单ID",name:'funpermissionids',id:'Js.Center.Popedom.RoleUpdate.FunPermitIds'}]},{columnWidth:.5,layout:'form',defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:0px 0 0px 15px",labelWidth:130,items:[{xtype:"textfield",fieldLabel:"选择可使用的业务内容",hidden:true},{html:'<div id="Js.Center.Popedom.RoleUpdate.product_groupPanel" style="float:left;margin:0px;border:1px solid #c3daf9;width:230px;height:220px;"></div>'},{xtype:"hidden",fieldLabel:"通道组ID",name:'productids',id:'Js.Center.Popedom.RoleUpdate.product_list'},{xtype:"hidden",fieldLabel:"客户组ID",name:'usergroupids',id:'Js.Center.Popedom.RoleUpdate.user_list'}]}]}]});var mainForm=updateInfoFormPanel.getForm();this.window=new WXTL.Widgets.CommonWindows.Window({title:"修改角色",width:'800',mainForm:mainForm,updateURL:Js.Center.Popedom.YXTUserFuncRoleUpdateURL,displayStore:Js.Center.Popedom.Role.Infostore,updateState:true,updateRecord:row,items:[updateInfoFormPanel],needButtons:false,needLoadDataStore:true,buttons:[new Ext.Button({text:'保存退出',minWidth:70,qtip:"保存退出",handler:function(){var idListArr=getAllChildrenNodes(PermissionTree.getRootNode());var ProductIdList=GetProductIdList(CreateProductUserGroupTree);var UserGroupIdList=GetUserGroupIdList(CreateProductUserGroupTree);var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0)idlist+=idListArr[i].id;else idlist+=','+idListArr[i].id}}}Ext.getCmp('Js.Center.Popedom.RoleUpdate.FunPermitIds').setValue(idlist);Ext.getCmp('Js.Center.Popedom.RoleUpdate.product_list').setValue(ProductIdList);Ext.getCmp('Js.Center.Popedom.RoleUpdate.user_list').setValue(UserGroupIdList);if(mainForm.isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Js.Center.Popedom.RoleUpdate.window.mainFormSubmitFunc()}}}),new Ext.Button({text:'重填',qtip:"重填",minWidth:70,handler:function(){updateInfoFormPanel.getForm().reset();updateInfoFormPanel.getForm().loadRecord(Js.Center.Popedom.RoleUpdate.window.updateRecord);CreateTree(Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numroleid"),Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numdepartid"));Create_Product_Tree(Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numroleid"),Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numdepartid"))}}),new Ext.Button({text:'下一步',qtip:"下一步",minWidth:70,handler:function(){var idListArr=getAllChildrenNodes(PermissionTree.getRootNode());var ProductIdList=GetProductIdList(CreateProductUserGroupTree);var UserGroupIdList=GetUserGroupIdList(CreateProductUserGroupTree);var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0)idlist+=idListArr[i].id;else idlist+=','+idListArr[i].id}}}Ext.getCmp('Js.Center.Popedom.RoleUpdate.FunPermitIds').setValue(idlist);Ext.getCmp('Js.Center.Popedom.RoleUpdate.product_list').setValue(ProductIdList);Ext.getCmp('Js.Center.Popedom.RoleUpdate.user_list').setValue(UserGroupIdList);if(mainForm.isValid()){Js.Center.Popedom.RoleUpdate.window.mainFormSubmitFunc('Js.Center.Popedom.RoleAdd.nextStepFunc(\''+updateInfoFormPanel.items.items[0].items.items[1].getValue()+'\', \''+updateInfoFormPanel.items.items[0].items.items[2].items.items[0].getValue()+'\', \''+updateInfoFormPanel.items.items[0].items.items[4].items.items[0].getValue()+'\', \''+updateInfoFormPanel.items.items[0].items.items[4].items.items[1].getValue()+'\')');}}}),new Ext.Button({text:'关闭',qtip:"关闭",minWidth:70,handler:function(){Js.Center.Popedom.RoleUpdate.window.hide()}})],loadDataStoreFunc:function(){CreateTree(Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numroleid"),Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numdepartid"));Create_Product_Tree(Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numroleid"),Js.Center.Popedom.RoleUpdate.window.updateRecord.get("numdepartid"))}});function CreateTree(roleId,departId){document.getElementById('Js.Center.Popedom.RoleUpdate.PermitTree').innerHTML='';Ext.get('Js.Center.Popedom.RoleUpdate.PermitTree').dom.innerHTML='';PermissionTree=new Ext.tree.TreePanel({applyTo:'Js.Center.Popedom.RoleUpdate.PermitTree',checkModel:'cascade',onlyLeafCheckable:false,style:'padding:5px 10px 10px 10px',animate:false,rootVisible:false,autoScroll:true,loader:new Ext.tree.TreeLoader({url:Js.Center.Popedom.UserFuncRoleURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={flag:'queryallrightsbyroleid',roleid:roleId,parentid:node.id,departid:departId,method:'POST'}},"load":function(loader,node,response){var childNodes=node.childNodes;if(childNodes&&childNodes.length>0){node.collapse(true)}}},baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI}}),root:new Ext.tree.AsyncTreeNode({id:'-1',text:'无线天利短信发送平台'})});PermissionTree.expandAll();Js.Center.Popedom.RoleAdd.nextStepFunc=function(roleid,rolename,departid,departname){var jsonObject=new Object();jsonObject.success="true";jsonObject.numroleid=roleid;jsonObject.vc2rolename=rolename;jsonObject.numdepartid=departid;jsonObject.vc2departname=departname;Js.Center.Popedom.Role.RolePermit.window.updateRecord=jsonObject;Js.Center.Popedom.Role.RolePermit.window.show()}};function Create_Product_Tree(ProductId,UserGroupId){document.getElementById('Js.Center.Popedom.RoleUpdate.product_groupPanel').innerHTML='';Ext.get('Js.Center.Popedom.RoleUpdate.product_groupPanel').dom.innerHTML='';CreateProductUserGroupTree=new Ext.tree.TreePanel({applyTo:'Js.Center.Popedom.RoleUpdate.product_groupPanel',checkModel:'parentCascade',onlyLeafCheckable:false,style:'padding:5px 10px 0px 10px',animate:false,rootVisible:false,autoScroll:true,listeners:{"checkchange":function(node,checked){var node_length=node.childNodes.length;if(checked==false&&node_length>=1){node.eachChild(function(child){child.ui.toggleCheck(false);child.attributes.checked=false;child.fireEvent('checkchange',child,checked)})}}},loader:new Ext.tree.TreeLoader({url:Js.Center.Business.YXTProductURL,listeners:{"beforeload":function(treeloader,node){Ext.MessageBox.show({msg:'正在加载，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});treeloader.baseParams={flag:'selectpermitbydepartidwithroleid',roleid:ProductId,columnlist:'numprodid,vc2name',departid:UserGroupId,method:'POST'}},"load":function(loader,node,response){var childNodes=node.childNodes;if(childNodes&&childNodes.length>0){node.collapse(true)}setTimeout(function(){Ext.MessageBox.hide()},1000)}},baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI}}),root:new Ext.tree.AsyncTreeNode({id:'-1',text:'无线天利短信发送平台'}),tbar:[new Ext.form.TextField({width:200,emptyText:'Find a Class',listeners:{render:function(f){f.el.on('keydown',filterTree,f,{buffer:350})}}})]});var hiddenPkgs=[];function filterTree(e){var text=e.target.value;Ext.each(hiddenPkgs,function(n){n.ui.show()});if(!text){filter.clear();return}CreateProductUserGroupTree.expandAll();var re=new RegExp(Ext.escapeRe(text),'i');filter.filterBy(function(n){var textval=n.text;return n.isLeaf()||n.attributes.checked||re.test(n.text)});hiddenPkgs=[];CreateProductUserGroupTree.root.cascade(function(n){if(!n.isLeaf()&&n.ui.ctNode.offsetHeight<3&&!re.test(n.text)){if(!n.attributes.checked){n.ui.hide();hiddenPkgs.push(n)}}if(n.id!='root'){if(!n.isLeaf()&&n.ui.ctNode.offsetHeight>=3&&hasChild(n,re)==false&&!re.test(n.text)){if(!n.attributes.checked){n.ui.hide();hiddenPkgs.push(n)}}}});function hasChild(n,re){var str=false;n.cascade(function(n1){if(re.test(n1.text)){str=true;return}});return str}};var filter=new Ext.tree.TreeFilter(CreateProductUserGroupTree,{clearBlank:true,autoClear:true});CreateProductUserGroupTree.expandAll()};function GetUserGroupIdList(varTree){var idListArr=getAllChildrenNodes(varTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].id!='-1'&&idListArr[i].attributes.parentid!='-1'&&idListArr[i].attributes.checked){if(idlist.length==0){idlist+=idListArr[i].id}else{idlist+=','+idListArr[i].id}}}}return idlist};function GetProductIdList(varTree,varWhere){var idListArr=getAllChildrenNodes(varTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].attributes.parentid=='-1'&&idListArr[i].attributes.checked){if(idlist.length==0){idlist+=idListArr[i].id}else{idlist+=','+idListArr[i].id}}}}return idlist}};Ext.namespace('Js.Center.Popedom.RoleAdd');Js.Center.Popedom.UserFuncRoleUpdateURL='URL/Temp_Purview/userfuncrole/userfuncroleupdate.ashx';Js.Center.Popedom.YXTUserFuncRoleUpdateURL='URL/Temp_Purview/userfuncrole/YXTuserfuncroleupdate.ashx';Js.Center.Popedom.UserFuncRoleURL='URL/Temp_Purview/UserFuncRole/UserFuncRoleQuery.ashx';Js.Center.Business.YXTProductURL='URL/system/product/YXTproducts.ashx';