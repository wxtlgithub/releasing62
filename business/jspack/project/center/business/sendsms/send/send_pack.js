Ext.namespace('Js.Center.SendSMS.Send');Js.Center.SendSMS.Send.info=function(node){if(Ext.get("Js.Center.SendSMS.Send.Mainpanel")==null){var _pageSize=12;Js.Center.SendSMS.Send.DisplayStore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.SmsContentURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numcontentid","vc2content","datsend","vc2status","numstate","nummessageformat","numsendmethod","numpriority","vc2detail","numcheck","vc2reason","datcreate","numcreaterid","datpresend","numcheck1id","datcheck1","numcheck2id","datcheck2","numprenum","numprodid","numsource","vc2typelist","numstatename","numsendtypename","numsendtype","nummessageformatname","vc2departname","vc2username"],root:"data",id:"numlogid",totalProperty:"totalCount"}),sortInfo:{field:'datcreate',direction:'DESC'},baseParams:{flag:'selectbykey',state:"3,4",numsendtype:"2,4,5,6,7,9",vc2content:""}});Js.Center.SendSMS.Send.DisplayStore.load({params:{start:0,limit:_pageSize}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numcontentid"});var cm=new Ext.grid.ColumnModel([{header:"短信内容",tooltip:"短信内容",dataIndex:"vc2content",width:220,renderer:function(value){return"<font qtip='"+value+"'>"+value+"</font>"},sortable:true},{header:"发送人",tooltip:"发送人",dataIndex:"vc2username",sortable:true},{header:"部门",tooltip:"部门",dataIndex:"vc2departname",sortable:true},{header:"发送类型",tooltip:"发送类型",dataIndex:"numsendtypename",sortable:true},{header:"发送时间",tooltip:"发送时间",dataIndex:"datsend",sortable:true},{header:"审核状态",tooltip:"审核状态",dataIndex:"numstatename",sortable:true},{header:"驳回原因",tooltip:"驳回原因",dataIndex:"vc2reason",sortable:true,renderer:function(value){return"<font qtip='"+value+"'>"+value+"</font>"}},{header:"内容类型",tooltip:"内容类型",dataIndex:"nummessageformatname",sortable:true},{header:"创建时间",tooltip:"创建时间",dataIndex:"datcreate",sortable:true},{header:"操作",tooltip:"操作",dataIndex:"numsvcid",renderer:function(value,meta,record,rowIndex,colIndex,store){return"<a href='#' onclick='doEditSMS(\""+rowIndex+"\")'>编辑</a>　<a href='#' onclick='sendSmsDelete(\""+record.data.numcontentid+"\")'>删除</a>"}}]);var gridPanel=new WXTL.Widgets.CommonGrid.GridPanel({title:"信息列表",anchor:'100% 100%',pageSize:_pageSize,store:Js.Center.SendSMS.Send.DisplayStore,needMenu:false,needRightMenu:false,sm:sm,cm:cm,tbar:new Ext.Toolbar({items:[{iconCls:'addmmsicon',text:"发送短信",handler:function(){Js.Center.SendSMS.SMSsend.UserGroupStore.baseParams={flag:"selectallbyprodid",prodId:""};Js.Center.SendSMS.Send.gridRecord=null;Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord=null;Js.Center.SendSMS.SMSsend.SMSsendInfoWin.show();Ext.getCmp("SMSsendtestmobile").setValue(Js.Center.Common.userMobile)}},{iconCls:'addmmsicon',text:"发送个性化短信",handler:function(){Js.Center.SendSMS.Send.gridRecord=null;Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord=null;Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.show();Ext.getCmp("SMSsendtestmobilediy").setValue(Js.Center.Common.userMobile)}}]})});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({queryMethod:"Js.Center.SendSMS.Send.queryGrid",items:[{layout:'column',items:[{xtype:"hidden",name:"flag",value:"insert"},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[{xtype:"datefield",fieldLabel:"开始时间",format:'Y-m-d',labelWidth:100,bodyStyle:'padding:5px 5px 0',readOnly:true,emptyText:Ext.util.Format.date(WXTL.Common.dateTime.addDay(WXTL.Common.dateTime.getNow(),-7),'Y-m-d'),fieldLabel:"开始时间",name:"datcreattimestart"},{xtype:"combo",name:"numdepartid",fieldLabel:"选择部门",hiddenName:"numproductid",readOnly:true,mode:"local",displayField:"vc2name",valueField:"value",triggerAction:"all",emptyText:'-=请选择=-',store:Js.Center.Common.DepartmentStore}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[{xtype:"datefield",fieldLabel:"结束时间",labelWidth:100,format:'Y-m-d',bodyStyle:'padding:5px 5px 0',readOnly:true,emptyText:Ext.util.Format.date(WXTL.Common.dateTime.getNow(),'Y-m-d'),name:"datcreattimeend"},{xtype:"combo",name:"numcolumnid",fieldLabel:"选择栏目",emptyText:'-=请选择=-',hiddenName:"numcolumnid",readOnly:true,mode:"local",displayField:"vc2name",valueField:"value",triggerAction:"all",store:Js.Center.Common.ColumnStore}]}]}]});Js.Center.SendSMS.Send.queryGrid=function(){Js.Center.SendSMS.Send.DisplayStore.baseParams={flag:'selectbykey',state:"3,4",numsendtype:"2,4,5,6,7,9",vc2content:""};Js.Center.SendSMS.Send.DisplayStore.reload()};Js.Center.SendSMS.Send.Mainpanel=new Ext.Panel({id:"Js.Center.SendSMS.Send.Mainpanel",frame:true,bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[gridPanel]})};GridMain(node,Js.Center.SendSMS.Send.Mainpanel,"openroomiconinfo","Js.Center.SendSMS.Send.DisplayStore");Js.Center.SendSMS.SMSsend.func(false);Js.Center.SendSMS.SMSsenddiy.func(false);Js.Center.SendSMS.Sendbycustomer.func(false);Js.Center.SendSMS.Sendbyenterprise.func(false)};function doEditSMS(id){var row=Js.Center.SendSMS.Send.DisplayStore.getAt(id);if(row.get('numsendtype')=="9"||row.get('numsendtype')=="8"){Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord=row;Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.show();Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").setValue(row.data.vc2content.replace(USERIOGRAPH,''));Ext.getCmp("SMSsendtestmobilediy").setValue(Js.Center.Common.userMobile)}else if(row.get('numsendtypename')=="客户通讯录"){Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.updateRecord=row;Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.show();if(row.data.vc2content.indexOf(USERIOGRAPH)>-1){Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendSMSContent").setValue(row.data.vc2content.replace(USERIOGRAPH,''));document.getElementById("Js.Center.SendSMS.Sendbycustomer.cbk").checked=true}else{document.getElementById("Js.Center.SendSMS.Sendbycustomer.cbk").checked=false}Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendTestMobile").setValue(Js.Center.Common.userMobile)}else{Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord=row;Js.Center.SendSMS.SMSsend.SMSsendInfoWin.show();Ext.getCmp('Js.Center.SendSMS.SMSsend.SendSMSContent').setValue(Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord.data.vc2content);if(row.data.vc2content.indexOf(USERIOGRAPH)>-1){Ext.getCmp("Js.Center.SendSMS.SMSsend.SendSMSContent").setValue(row.data.vc2content.replace(USERIOGRAPH,''));}else{}Ext.getCmp("SMSsendtestmobile").setValue(Js.Center.Common.userMobile);Ext.get("sendnumsendtype").dom.value='sendbyusergroup'}Js.Center.SendSMS.SMSsend.UserGroupStore.baseParams.prodId="";Js.Center.SendSMS.SMSsend.UserGroupStore.reload()};function sendSmsDelete(row){Ext.Msg.confirm("提示!","您确定要删除信息吗?",function(btn){if(btn=="yes"){Js.Center.SendSMS.SMSDelete.func(row)}else{}})};function checkSMSFilingSign(prodId,smsContent){var flag=false;var signInfo=doSynRequest(Js.Center.Business.ECmanage.ECSigntureURL+"?flag=selectsignaturebyprodid&numprodid="+prodId);if(signInfo.success){if(signInfo.totalCount==0){return true}else{var signType=signInfo.data[0].numsigntypeid;if(signType==3){return true}else if(signType==2){for(var i=0;i<signInfo.totalCount;i++){var sign=signInfo.data[i].vc2signture;if(Js.Center.Common.userSignature!=null&&Js.Center.Common.userSignature!=''){var startIndex=Js.Center.Common.userSignature.length-sign.length;var smsSign=Js.Center.Common.userSignature.substring(startIndex);if(sign==smsSign){return true}}else if(smsContent.length>=sign.length){var startIndex=smsContent.length-sign.length;var smsSign=smsContent.substring(startIndex);if(sign==smsSign){return true}}}}else if(signType==1){if(Js.Center.Common.userSignature!=null&&Js.Center.Common.userSignature!=''){for(var i=0;i<signInfo.totalCount;i++){var sign=signInfo.data[i].vc2signture;if(sign==Js.Center.Common.userSignature){return true}}}else if((smsContent.indexOf("[")>0&&smsContent.lastIndexOf("]")==smsContent.length-1)||(smsContent.indexOf("【")>0&&smsContent.lastIndexOf("】")==smsContent.length-1)){var smsSign=smsContent.substring(smsContent.indexOf("["),smsContent.lastIndexOf("]")+1);if(smsSign==""){smsSign=smsContent.substring(smsContent.indexOf("【"),smsContent.lastIndexOf("】")+1)}for(var i=0;i<signInfo.totalCount;i++){var sign=signInfo.data[i].vc2signture;if(sign==smsSign){return true}else{var EsmsSign=smsSign;if(EsmsSign.lastIndexOf("]")==EsmsSign.length-1){EsmsSign=EsmsSign.replace("[","【");EsmsSign=EsmsSign.replace("]","】")}else{EsmsSign=EsmsSign.replace("【","[");EsmsSign=EsmsSign.replace("】","]")}if(sign==EsmsSign){return true}}}}}}}if(!flag){Ext.Msg.alert("温馨提示","对不起,短信签名不符合规范！")}return flag};Ext.namespace('Js.Center.SendSMS.Sendbycustomer');var customerTreeCheckedData=new Array();Js.Center.SendSMS.Sendbycustomer.func=function(show,row){var testFormat="15";var LOCALUSERIOGRAPH="";var LOCALUSERIOGRAPHSIZE=0;Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph=function(chkbox){LOCALUSERIOGRAPH=(chkbox)?USERIOGRAPH:"";LOCALUSERIOGRAPHSIZE=(chkbox)?USERIOGRAPHSIZE:0;if(Js.Center.SendSMS.Sendbycustomer.nummessageformatName=="短信"){Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendSMSContent").contentMaxLength=70-LOCALUSERIOGRAPHSIZE}else{Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").contentMaxLength=246-LOCALUSERIOGRAPHSIZE}Ext.get("Js.Center.SendSMS.Sendbycustomer.vc2signature").dom.value=LOCALUSERIOGRAPH};if(Ext.get("Js.Center.SendSMS.Sendbycustomer.Mainpanel")==null){Js.Center.SendSMS.Sendbycustomer.customerTreeCheckedInfo=function(){customerTreeCheckedData=new Array();var listArr=getAllChildrenNodes(EmployeeTree.getRootNode());for(var i=0;i<listArr.length;i++){if(listArr[i].attributes){if(listArr[i].attributes.id!='-1'&&listArr[i].attributes.checked&&listArr[i].attributes.numusergroupmemberid!=undefined){var selectTree=new Object();selectTree.data=new Object();selectTree.data.numusergroupid=listArr[i].attributes.numusergroupid;selectTree.data.vc2customer=listArr[i].attributes.vc2customer;selectTree.data.numusergroupmemberid=listArr[i].attributes.numusergroupmemberid;selectTree.data.vc2usergroupname=listArr[i].attributes.vc2usergroupname;selectTree.data.vc2mobile=listArr[i].attributes.vc2mobile;customerTreeCheckedData.push(selectTree)}}}return customerTreeCheckedData};var isSelfValid=function(){var valid=true;var idListArr=getAllChildrenNodes(EmployeeTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes&&idListArr[i].attributes.vc2mobile){if(idListArr[i].attributes.id!='-1'&&idListArr[i].attributes.checked&&idListArr[i].attributes.vc2mobile.toString()!="null"){if(idlist.length==0){idlist+=idListArr[i].attributes.vc2mobile.toString()}else{idlist+=','+idListArr[i].attributes.vc2mobile.toString()}}}}if(idlist==""){Ext.Msg.alert("温馨提示","请选择发送对象!");valid=false}else{document.getElementById("Js.Center.SendSMS.Sendbycustomer.MobileList").value=idlist}if(Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendMethod").items.items[1].checked){var sendTime=Ext.get("Js.Center.SendSMS.Sendbycustomer.datsrcsendtime").getValue();var datNow=Ext.util.Format.date(WXTL.Common.dateTime.getNow(),'Y-m-d h:m:s');if(sendTime<datNow){Ext.Msg.alert("温馨提示"," 定时发送短信发送时间不能早于当前时间!");valid=false}}if(!SMSSendPanel.getForm().isValid()){valid=false}return valid};Js.Center.SendSMS.Sendbycustomer.func.saveSMS=function(method){if(Ext.get("Js.Center.SendSMS.Sendbycustomer.SendFlag")!=null)Ext.get("Js.Center.SendSMS.Sendbycustomer.SendFlag").dom.value=method;if(isSelfValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);SMSSendPanel.getForm().submit({url:Js.Center.SendSMS.SmsContentUpdateURL,method:"POST",success:function(form,action){if(action.response.responseText!=""){var objJson=Ext.util.JSON.decode(action.response.responseText);var falg=objJson.success;if(falg==true){Ext.Msg.alert("温馨提示","操作成功了!");Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.hide();Js.Center.SendSMS.Send.DisplayStore.reload()}else Ext.Msg.alert('温馨提示',objJson.info)}else{Ext.Msg.alert("温馨提示","操作成功了!");Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.hide();Js.Center.SendSMS.Send.DisplayStore.reload()}},failure:function(form,action){var objJson=Ext.util.JSON.decode(action.response.responseText);Ext.Msg.alert('温馨提示',objJson.info)}})}};var smsContent=new WXTL.Widgets.CommonForm.Textarea({name:'vc2content',id:"Js.Center.SendSMS.Sendbycustomer.SendSMSContent",labelText:Ext.isIE?"账户签名：<input type='checkbox' value='1' id='Js.Center.SendSMS.Sendbycustomer.cbk' onclick='Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(this.checked)'>"+USERIOGRAPH:"<div style='height: 13px; display: block; float: left; width: 66px;'>账户签名：</div><div style='height: 13px; width: 13px; display: block; float: left; padding: 2px 0pt 0pt;'><input type='checkbox' value='1' id='Js.Center.SendSMS.Sendbycustomer.cbk' onclick='Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(this.checked)'></div>"+USERIOGRAPH,fieldLabel:'<font color=red>短信内容</font>',contentMaxLength:246-LOCALUSERIOGRAPHSIZE,textareaConfig:{allowBlank:false,autocomplete:'on',blankText:"请输入短信内容",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText}});var productCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"numproductid",hiddenName:"numproductid",id:'Js.Center.SendSMS.Sendbycustomer.SMSnumproductid',emptyText:"-=请选择=-",allowBlank:false,blankText:"请选择通道组",fieldLabel:"<font color=red>选择通道组</font>",readOnly:true,mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:Js.Center.Common.ProductStore});var smsFieldSet=new Ext.form.FieldSet({title:'短信内容',collapsible:false,autoHeight:true,defaultType:'textfield',style:Ext.isIE?'padding:5px 0 0 10px;':'padding:0 0 0 10px;',layout:'form',items:[productCombox,{xtype:"combo",name:"numpriority",fieldLabel:"<font color=red>优先级</font>",hiddenName:"numpriority",readOnly:true,mode:"local",displayField:"show",valueField:"value",triggerAction:"all",allowBlank:false,blankText:"优先级类型不允许为空",emptyText:"请选择",value:0,store:new Ext.data.SimpleStore({fields:["show","value"],data:[["正常","0"],["及时","1"],["紧急","2"]]})},{xtype:"radiogroup",fieldLabel:"<font color=red>短信模式</font>",allowBlank:true,horizontal:true,defaultValue:'true',items:[{boxLabel:getHelpMsg("短信",false,'1、内容长度须小于等于70字。'),inputValue:'15',name:'nummessageformat',listeners:{"check":function(checkbox,checked){if(checked){testFormat="15";smsContent.contentMaxLength=70-LOCALUSERIOGRAPHSIZE;Js.Center.SendSMS.Sendbycustomer.nummessageformatName="短信"}}}},{boxLabel:getHelpMsg("长短信",false,'1、内容长度须小于等于246字。'),inputValue:'32',name:'nummessageformat',checked:true,listeners:{"check":function(checkbox,checked){if(checked){testFormat="32";smsContent.contentMaxLength=246-LOCALUSERIOGRAPHSIZE;Js.Center.SendSMS.Sendbycustomer.nummessageformatName="长短信"}}}}]},{xtype:'hidden',name:'flag',id:'Js.Center.SendSMS.Sendbycustomer.SendFlag',value:'submit',fieldLabel:'操作类型'},{xtype:'hidden',name:'mobilelist',id:'Js.Center.SendSMS.Sendbycustomer.MobileList',fieldLabel:'发送对象ID'},{xtype:'hidden',name:'numsendtype',value:'sendbyeuserdirectory',fieldLabel:'发送类型'},{xtype:'hidden',name:'numcontentid',fieldLabel:'短信内容编号'},smsContent,{xtype:'hidden',id:'Js.Center.SendSMS.Sendbycustomer.vc2signature',name:'vc2signature',value:LOCALUSERIOGRAPH,readOnly:true,fieldLabel:'<font color=red>账户签名</font>'},{xtype:"radiogroup",fieldLabel:"<font color=red>发送方式</font>",id:"Js.Center.SendSMS.Sendbycustomer.SendMethod",allowBlank:true,horizontal:true,defaultValue:'true',items:[{boxLabel:'立即发送',name:"numsendmethod",inputValue:'1',checked:true},{boxLabel:'定时发送',name:"numsendmethod",inputValue:'2'}]},{xtype:'xDateTime',fieldLabel:'发送时间',name:"datsend",id:"Js.Center.SendSMS.Sendbycustomer.datsrcsendtime",timeFormat:'H:i:s',value:WXTL.Common.dateTime.getNow(),timeConfig:{altFormats:'H:i:s',allowBlank:true,invalidText:'{0} 是无效的时间-必须符合格式为：H:i:s'},dateFormat:'Y-m-d',dateConfig:{altFormats:'Y-m-d',allowBlank:true}}]});var smsSendTestPanel=new Ext.Panel({frame:true,labelWidth:80,border:false,bodyBorder:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 5px;',anchor:'90%'},items:[{columnWidth:.7,layout:'form',border:false,defaults:{anchor:'90%'},items:[{xtype:"textfield",name:"vc2mobile",value:Js.Center.Common.userMobile,id:"Js.Center.SendSMS.Sendbycustomer.SendTestMobile",fieldLabel:"测试手机号",regex:WXTL.Common.regex.Mobile,regexText:"手机号码格式不正确"}]},{columnWidth:.3,layout:'form',border:false,items:[{xtype:'button',id:'Js.Center.SendSMS.Sendbycustomer.SMSsendtestbtnsendtest',text:'发送测试短信',handler:function(){if(Ext.get("Js.Center.SendSMS.Sendbycustomer.SendTestMobile").getValue()==""||Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SMSnumproductid").getValue()==""){Ext.Msg.alert("温馨提示","测试手机号码和通道组不能为空!")}else{if(smsContent.isValid()&&Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendTestMobile").isValid()){if(Ext.get("Js.Center.SendSMS.Sendbycustomer.SendFlag")!=null)Ext.get("Js.Center.SendSMS.Sendbycustomer.SendFlag").dom.value="sendtest";Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var parms={flag:'sendtest',vc2mobile:Ext.get("Js.Center.SendSMS.Sendbycustomer.SendTestMobile").dom.value,numclassid:'0',vc2content:smsContent.getValue(),vc2signature:LOCALUSERIOGRAPH,nummessageformat:testFormat,numproductid:Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SMSnumproductid").getValue(),datsend:Ext.get("Js.Center.SendSMS.Sendbycustomer.datsrcsendtime").dom.value};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,parms)}}}}]}]}]});var root=new Ext.tree.TreeNode({id:'-1',text:'无线天利短信发送平台',checked:false});var ToRepeatCustomerGroup=function(){var newArray=new Array();var len=usergroupStore.length;for(var i=0;i<len;i++){for(var j=i+1;j<len;j++){if(usergroupStore[i].data.numusergroupid==usergroupStore[j].data.numusergroupid){j=++i}}newArray.push(usergroupStore[i])}return newArray};var ToRepeatCustomerGroupMember=function(){var newArray=new Array();var len=usergroupStore.length;for(var i=0;i<len;i++){for(var j=i+1;j<len;j++){if(usergroupStore[i].data.numusergroupmemberid==usergroupStore[j].data.numusergroupmemberid){j=++i}}newArray.push(usergroupStore[i])}return newArray};var EmployeeTree=new Ext.tree.TreePanel({checkModel:'cascade',onlyLeafCheckable:false,style:'padding:5px 10px 10px 10px',animate:false,lines:false,useArrows:true,collapsible:false,rootVisible:false,autoScroll:true,root:root,listeners:{"checkchange":function(node,checked){EmployeeTree.suspendEvents();if(node.hasChildNodes()){node.eachChild(function(child){child.ui.toggleCheck(checked);child.attributes.checked=checked;})}else{var parent=node.parentNode;var flag=node.getUI().checkbox.checked;if(parent!=null){parent.ui.toggleCheck(checked);parent.attributes.checked=checked;}}EmployeeTree.resumeEvents()}}});Js.Center.SendSMS.Sendbycustomer.func.isCreateTree=function(){var children=root.childNodes;var childrenLen=children.length;for(var i=0;i<childrenLen;i++){root.removeChild(children[0])}if(usergroupStore.length!=0){var nodeTree='';var ToRepeatData=ToRepeatCustomerGroup();var ToRepeatMemberData=ToRepeatCustomerGroupMember();for(var i=0;i<ToRepeatData.length;i++){nodeTree=root.appendChild(new Ext.tree.TreeNode({id:"g"+i,text:ToRepeatData[i].data.vc2usergroupname,numusergroupid:ToRepeatData[i].data.numusergroupid,icon:"Images/icons/homemanage.gif",allowDrag:false,checked:true,expanded:true}));for(var j=0;j<ToRepeatMemberData.length;j++){if(ToRepeatData[i].data.numusergroupid==ToRepeatMemberData[j].data.numusergroupid){nodeTree.appendChild(new Ext.tree.TreeNode({id:"u"+j,text:ToRepeatMemberData[j].data.vc2customer,numusergroupid:ToRepeatMemberData[j].data.numusergroupid,numusergroupmemberid:ToRepeatMemberData[j].data.numusergroupmemberid,icon:"Images/icons/usericon.gif",allowDrag:false,checked:true,expanded:true,vc2customer:ToRepeatMemberData[j].data.vc2customer,vc2usergroupname:ToRepeatMemberData[j].data.vc2usergroupname,vc2mobile:ToRepeatMemberData[j].data.vc2mobile}))}}}usergroupStore=new Array()}};var smsEnterprisePanel=new Ext.Panel({title:'请选择部门成员',frame:true,bodyBorder:false,border:false,height:385,autoScroll:true,layout:"anchor",defaults:{collapsible:false},buttonAlign:"left",items:[EmployeeTree],buttons:[{text:"选择客户组成员",minWidth:70,handler:function(){Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.show()}}]});var SMSSendPanel=new Ext.FormPanel({fileUpload:true,labelAlign:'left',frame:true,style:"background-color:#e7e8f0",defaults:{msgTarget:"side"},items:[{items:[{layout:'column',items:[{columnWidth:.3,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",items:[smsEnterprisePanel]},{columnWidth:.7,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[smsFieldSet,smsSendTestPanel]}]}]}]});var mainForm=SMSSendPanel.getForm();Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin=new WXTL.Widgets.CommonWindows.Window({title:"按客户通讯录发送",width:950,heigth:600,mainForm:SMSSendPanel.getForm(),needButtons:false,closeAction:'hide',updateURL:Js.Center.SendSMS.SmsContentUpdateURL,displayStore:Js.Center.SendSMS.Send.DisplayStore,updateState:true,updateRecord:row,items:[SMSSendPanel],buttons:[{text:"提交发送",minWidth:70,handler:function(){Js.Center.SendSMS.Sendbycustomer.func.saveSMS("submit")}},{text:"保存",minWidth:70,handler:function(){Js.Center.SendSMS.Sendbycustomer.func.saveSMS("save")}},{text:"重置",minWidth:70,qtip:"重置数据",handler:function(){var row=Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.updateRecord;if(row!=null){SMSSendPanel.getForm().reset();SMSSendPanel.getForm().loadRecord(row);if(row.data.vc2content.indexOf(USERIOGRAPH)>-1){Ext.getCmp("Js.Center.SendSMS.Sendbycustomer.SendSMSContent").setValue(row.data.vc2content.replace(USERIOGRAPH,''));document.getElementById("Js.Center.SendSMS.Sendbycustomer.cbk").checked=true;Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(true)}else{Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(false)}}else{SMSSendPanel.getForm().reset();document.getElementById("Js.Center.SendSMS.Sendbycustomer.cbk").checked=false;Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(false)}}},{text:"取消",minWidth:70,qtip:"取消",handler:function(){Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.hide();SMSSendPanel.getForm().reset()}}],listeners:{"show":function(){Js.Center.Common.ProductStore.reload();Js.Center.SendSMS.Sendbycustomer.func.isCreateTree();Js.Center.SendSMS.sendbycustomer.customerQueryInfo()},"beforehide":function(){SMSSendPanel.getForm().reset();document.getElementById("Js.Center.SendSMS.Sendbycustomer.cbk").checked=false;Js.Center.SendSMS.Sendbycustomer.func.toggleChkGraph(false)}}})}if(show){Js.Center.SendSMS.Sendbycustomer.SMSsendInfoWin.show()}};Ext.namespace('Js.Center.SendSMS.sendbycustomer');var usergroupStore=new Array();Js.Center.SendSMS.sendbycustomer.customerQueryInfo=function(show){if(Ext.get("Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.SelectPanel")==null){var _pageSize=12;var datafields=["numusergroupmemberid","vc2customer","vc2mobile","vc2usergroupname","numusergroupid"];Js.Center.SendSMS.sendbycustomer.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.sendbycustomerURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:datafields,root:"data",id:"numusergroupmemberid",totalProperty:"totalCount"}),baseParams:{flag:'getusergroupmember',vc2membername:'',vc2mobile:'',numgroupid:''},listeners:{"load":function(){Js.Center.SendSMS.sendbycustomer.getSelectionModel()}}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numusergroupmemberid"});var cm=new Ext.grid.ColumnModel([sm,{header:"客户姓名",tooltip:"客户姓名",dataIndex:"vc2customer",sortable:true},{header:"手机号码",tooltip:"手机号码",dataIndex:"vc2mobile",sortable:true},{header:"所属客户组",tooltip:"所属客户组",dataIndex:"vc2usergroupname",sortable:true}]);var customerGroupGrid=new WXTL.Widgets.CommonGrid.GridPanel({id:"Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.usergroupGridPanel",width:600,anchor:'100% 100%',needMenu:false,needRightMenu:false,pageSize:_pageSize,store:Js.Center.SendSMS.sendbycustomer.Infostore,sm:sm,cm:cm});var customerGroupCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"combo",name:"numusergroupid",id:'Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.customerGroup',fieldLabel:"所属客户组",hiddenName:"numusergroupid",readOnly:true,mode:"local",displayField:"vc2usergroupname",valueField:"numusergroupid",triggerAction:"all",store:Js.Center.Common.UserGroupStoreByUser});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({id:"Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.SelectPanel",height:120,width:600,queryMethod:"Js.Center.SendSMS.sendbycustomer.queryGrid",items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},items:[new Ext.form.TextField({fieldLabel:'手机号码',name:'vc2mobile',id:'Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.Mobile',regex:WXTL.Common.regex.Mobile,regexText:'请输入正确的手机号码格式',maxLength:11,maxLengthText:'长度不能超过11'}),customerGroupCombox]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},items:[{xtype:"textfield",name:"vc2customername",id:"Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.CustomerName",fieldLabel:"客户姓名",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50,maxLengthText:'长度不能超过50'}]}]}]});Js.Center.SendSMS.sendbycustomer.queryGrid=function(){if(selectPanel.getForm().isValid()){var x=Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.getPosition()[0];Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.setPagePosition(x,50);var flag='getusergroupmember';var customerName=Ext.get("Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.CustomerName").getValue();var numGroupId=Ext.getCmp("Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.customerGroup").getValue();var vc2mobile=Ext.get("Js.Center.SendSMS.sendbycustomer.sendbycustomerquery.Mobile").getValue();Js.Center.SendSMS.sendbycustomer.Infostore.baseParams={vc2membername:customerName,flag:flag,vc2mobile:vc2mobile,numgroupid:numGroupId};Js.Center.SendSMS.sendbycustomer.Infostore.load({params:{start:0,limit:_pageSize}})}};Js.Center.SendSMS.sendbycustomer.MainPanel=new Ext.Panel({id:"Js.Center.SendSMS.sendbycustomer.mainpanel",frame:true,bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[selectPanel,customerGroupGrid]});Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin=new WXTL.Widgets.CommonWindows.Window({title:"客户查询",width:620,mainForm:selectPanel.getForm(),needButtons:false,closeAction:'hide',updateState:true,items:[selectPanel,customerGroupGrid],buttons:[new Ext.Button({text:'确定',minWidth:70,handler:function(){Js.Center.SendSMS.sendbycustomer.customerGridCheckedInfo();Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.hide();Js.Center.SendSMS.Sendbycustomer.func.isCreateTree()}}),new Ext.Button({text:'取消',minWidth:70,handler:function(){Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.hide()}})],listeners:{"show":function(){Js.Center.Common.UserGroupStoreByUser.reload();Js.Center.SendSMS.Sendbycustomer.customerTreeCheckedInfo()},"beforehide":function(){selectPanel.getForm().reset();Js.Center.SendSMS.sendbycustomer.SMSsendbycustomerInfoWin.mainForm.reset();Js.Center.SendSMS.sendbycustomer.Infostore.load({params:{start:0,limit:0}})}}});Js.Center.SendSMS.sendbycustomer.customerGridCheckedInfo=function(){usergroupStore=new Array();var usergroupData=customerGroupGrid.getSelectionModel().getSelections();var arrLen=customerTreeCheckedData.length;var len=Js.Center.SendSMS.sendbycustomer.Infostore.data.length;var items=Js.Center.SendSMS.sendbycustomer.Infostore.data.items;for(var i=0;i<usergroupData.length;i++){usergroupStore.push(usergroupData[i])}var isTrue=false;if(arrLen>0){for(var j=0;j<arrLen;j++){isTrue=false;for(var k=0;k<len;k++){if(items[k].data.numusergroupmemberid==customerTreeCheckedData[j].data.numusergroupmemberid){isTrue=true;break}}if(!isTrue){usergroupStore.push(customerTreeCheckedData[j])}}}return usergroupStore};Js.Center.SendSMS.sendbycustomer.getSelectionModel=function(){var selectModel=customerGroupGrid.getSelectionModel();var indexArry=new Array();var len=Js.Center.SendSMS.sendbycustomer.Infostore.data.length;var arrLen=customerTreeCheckedData.length;var items=Js.Center.SendSMS.sendbycustomer.Infostore.data.items;for(var i=0;i<len;i++){for(var j=0;j<arrLen;j++){if(items[i].data.numusergroupmemberid==customerTreeCheckedData[j].data.numusergroupmemberid){indexArry.push(i)}}}selectModel.selectRows(indexArry)}};if(show){Js.Center.SendSMS.sendbycustomer.SMSsendInfoWin.show()}};Ext.namespace('Js.Center.SendSMS.Sendbyenterprise');Js.Center.SendSMS.Sendbyenterprise.func=function(show,row){var testFormat="15";var LOCALUSERIOGRAPH="";var LOCALUSERIOGRAPHSIZE=0;Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph=function(chkbox){LOCALUSERIOGRAPH=(chkbox)?USERIOGRAPH:"";LOCALUSERIOGRAPHSIZE=(chkbox)?USERIOGRAPHSIZE:0;if(Js.Center.SendSMS.Sendbyenterprise.nummessageformatName=="短信"){Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SendSMSContent").contentMaxLength=70-LOCALUSERIOGRAPHSIZE}else{Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SendSMSContent").contentMaxLength=246-LOCALUSERIOGRAPHSIZE}Ext.get("Js.Center.SendSMS.Sendbyenterprise.vc2signature").dom.value=LOCALUSERIOGRAPH};if(Ext.get("Js.Center.SendSMS.Sendbyenterprise.Mainpanel")==null){var isSelfValid=function(){var valid=true;var idListArr=getAllChildrenNodes(EmployeeTree.getRootNode());var idlist='';for(var i=0;i<idListArr.length;i++){if(idListArr[i].attributes){if(idListArr[i].attributes.id!='-1'&&idListArr[i].attributes.checked&&idListArr[i].attributes.mobile.toString()!="null"){if(idlist.length==0){idlist+=idListArr[i].attributes.mobile.toString()}else{idlist+=','+idListArr[i].attributes.mobile.toString()}}}}if(idlist==""){Ext.Msg.alert("温馨提示","请选择发送对象!");valid=false}else{document.getElementById("Js.Center.SendSMS.Sendbyenterprise.MobileList").value=idlist}if(Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SendMethod").items.items[1].checked){var sendTime=Ext.get("Js.Center.SendSMS.Sendbyenterprise.datsrcsendtime").getValue();var datNow=Ext.util.Format.date(WXTL.Common.dateTime.getNow(),'Y-m-d h:m:s');if(sendTime<datNow){Ext.Msg.alert("温馨提示"," 定时发送短信发送时间不能早于当前时间!");valid=false}}if(!SMSSendPanel.getForm().isValid()){valid=false}return valid};Js.Center.SendSMS.Sendbyenterprise.func.saveSMS=function(method){if(Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendFlag")!=null)Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendFlag").dom.value=method;if(isSelfValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);SMSSendPanel.getForm().submit({url:Js.Center.SendSMS.SmsContentUpdateURL,method:"POST",success:function(form,action){if(action.response.responseText!=""){var objJson=Ext.util.JSON.decode(action.response.responseText);var falg=objJson.success;if(falg==true){Ext.Msg.alert("温馨提示","操作成功了!");Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin.hide();Js.Center.SendSMS.Send.DisplayStore.reload()}else Ext.Msg.alert('温馨提示',objJson.info)}else{Ext.Msg.alert("温馨提示","操作成功了!");Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin.hide();Js.Center.SendSMS.Send.DisplayStore.reload()}},failure:function(form,action){var objJson=Ext.util.JSON.decode(action.response.responseText);Ext.Msg.alert('温馨提示',objJson.info)}})}};var smsContent=new WXTL.Widgets.CommonForm.Textarea({name:'vc2content',id:"Js.Center.SendSMS.Sendbyenterprise.SendSMSContent",labelText:Ext.isIE?"账户签名：<input type='checkbox' value='1' id='Js.Center.SendSMS.Sendbyenterprise.cbk' onclick='Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(this.checked)'>"+USERIOGRAPH:"<div style='height: 13px; display: block; float: left; width: 66px;'>账户签名：</div><div style='height: 13px; width: 13px; display: block; float: left; padding: 2px 0pt 0pt;'><input type='checkbox' value='1' id='Js.Center.SendSMS.Sendbyenterprise.cbk' onclick='Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(this.checked)'></div>"+USERIOGRAPH,fieldLabel:'<font color=red>短信内容</font>',contentMaxLength:246-LOCALUSERIOGRAPHSIZE,textareaConfig:{allowBlank:false,autocomplete:'on',blankText:"请输入短信内容",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText}});var productCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"numproductid",hiddenName:"numproductid",id:'Js.Center.SendSMS.Sendbyenterprise.SMSnumproductid',emptyText:"-=请选择=-",allowBlank:false,blankText:"请选择通道组",fieldLabel:"<font color=red>选择通道组</font>",readOnly:true,mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:Js.Center.Common.ProductStore});var smsFieldSet=new Ext.form.FieldSet({title:'短信内容',collapsible:false,autoHeight:true,defaultType:'textfield',style:Ext.isIE?'padding:5px 0 0 10px;':'padding:0 0 0 10px;',layout:'form',items:[productCombox,{xtype:"combo",name:"numpriority",fieldLabel:"<font color=red>优先级</font>",hiddenName:"numpriority",readOnly:true,mode:"local",displayField:"show",valueField:"value",triggerAction:"all",allowBlank:false,blankText:"优先级类型不允许为空",emptyText:"请选择",value:0,store:new Ext.data.SimpleStore({fields:["show","value"],data:[["正常","0"],["及时","1"],["紧急","2"]]})},{xtype:"radiogroup",fieldLabel:"<font color=red>短信模式</font>",allowBlank:true,horizontal:true,defaultValue:'true',items:[{boxLabel:getHelpMsg("短信",false,'1、内容长度须小于等于70字。'),inputValue:'15',name:'nummessageformat',listeners:{"check":function(checkbox,checked){if(checked){testFormat="15";smsContent.contentMaxLength=70-LOCALUSERIOGRAPHSIZE;Js.Center.SendSMS.Sendbyenterprise.nummessageformatName="短信"}}}},{boxLabel:getHelpMsg("长短信",false,'1、内容长度须小于等于246字。'),inputValue:'32',name:'nummessageformat',checked:true,listeners:{"check":function(checkbox,checked){if(checked){testFormat="32";smsContent.contentMaxLength=246-LOCALUSERIOGRAPHSIZE;Js.Center.SendSMS.Sendbyenterprise.nummessageformatName="长短信"}}}}]},{xtype:'hidden',name:'flag',id:'Js.Center.SendSMS.Sendbyenterprise.SendFlag',value:'submit',fieldLabel:'操作类型'},{xtype:'hidden',name:'mobilelist',id:'Js.Center.SendSMS.Sendbyenterprise.MobileList',fieldLabel:'发送对象ID'},{xtype:'hidden',name:'numsendtype',value:'sendbyenterprisedirectory',fieldLabel:'发送类型'},{xtype:'hidden',name:'numcontentid',fieldLabel:'短信内容编号'},smsContent,{xtype:'hidden',name:'vc2signature',id:'Js.Center.SendSMS.Sendbyenterprise.vc2signature',value:LOCALUSERIOGRAPH,readOnly:true,fieldLabel:'<font color=red>账户签名</font>'},{xtype:"radiogroup",fieldLabel:"<font color=red>发送方式</font>",id:"Js.Center.SendSMS.Sendbyenterprise.SendMethod",allowBlank:true,horizontal:true,defaultValue:'true',items:[{boxLabel:'立即发送',name:"numsendmethod",inputValue:'1',checked:true},{boxLabel:'定时发送',name:"numsendmethod",inputValue:'2'}]},{xtype:'xDateTime',fieldLabel:'发送时间',name:"datsend",id:"Js.Center.SendSMS.Sendbyenterprise.datsrcsendtime",timeFormat:'H:i:s',value:WXTL.Common.dateTime.getNow(),timeConfig:{altFormats:'H:i:s',allowBlank:true,invalidText:'{0} 是无效的时间-必须符合格式为：H:i:s'},dateFormat:'Y-m-d',dateConfig:{altFormats:'Y-m-d',allowBlank:true}}]});var smsSendTestPanel=new Ext.Panel({frame:true,labelWidth:80,border:false,bodyBorder:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 5px;',anchor:'90%'},items:[{columnWidth:.7,layout:'form',border:false,defaults:{anchor:'90%'},items:[{xtype:"textfield",name:"vc2mobile",value:Js.Center.Common.userMobile,id:"Js.Center.SendSMS.Sendbyenterprise.SendTestMobile",fieldLabel:"测试手机号",regex:WXTL.Common.regex.Mobile,regexText:"手机号码格式不正确"}]},{columnWidth:.3,layout:'form',border:false,items:[{xtype:'button',id:'Js.Center.SendSMS.Sendbyenterprise.SMSsendtestbtnsendtest',text:'发送测试短信',handler:function(){if(Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendTestMobile").getValue()==""||Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SMSnumproductid").getValue()==""){Ext.Msg.alert("温馨提示","测试手机号码和通道组不能为空!")}else{if(smsContent.isValid()&&Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SendTestMobile").isValid()){if(Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendFlag")!=null)Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendFlag").dom.value="sendtest";Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var parms={flag:'sendtest',vc2mobile:Ext.get("Js.Center.SendSMS.Sendbyenterprise.SendTestMobile").dom.value,numclassid:'0',vc2content:smsContent.getValue(),vc2signature:LOCALUSERIOGRAPH,nummessageformat:testFormat,numproductid:Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SMSnumproductid").getValue(),datsend:Ext.get("Js.Center.SendSMS.Sendbyenterprise.datsrcsendtime").dom.value};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,parms)}}}}]}]}]});var EmployeeTree=new Ext.tree.TreePanel({checkModel:'cascade',onlyLeafCheckable:false,style:'padding:5px 10px 10px 10px',animate:false,lines:false,useArrows:true,collapsible:false,rootVisible:false,autoScroll:true,loader:new Ext.tree.TreeLoader({url:Js.Center.SendSMS.sendbycustomerURL,listeners:{"beforeload":function(treeloader,node){treeloader.baseParams={flag:'getenterprisedirectory',parentid:node.id.toString().indexOf("d")>=0?node.id.toString().substring(1,node.id.toString().length):node.id,method:'POST'}}},baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI}}),root:new Ext.tree.AsyncTreeNode({id:'-1',text:'无线天利短信发送平台'})});var smsEnterprisePanel=new Ext.Panel({title:'请选择部门成员',frame:true,bodyBorder:false,border:false,height:385,autoScroll:true,layout:"anchor",defaults:{collapsible:false},tbar:new Ext.Toolbar({text:"发送短信",handler:function(){}}),items:[EmployeeTree]});var SMSSendPanel=new Ext.FormPanel({fileUpload:true,labelAlign:'left',frame:true,style:"background-color:#e7e8f0",defaults:{msgTarget:"side"},items:[{items:[{layout:'column',items:[{columnWidth:.3,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",items:[smsEnterprisePanel]},{columnWidth:.7,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},buttonAlign:"center",items:[smsFieldSet,smsSendTestPanel]}]}]}]});var mainForm=SMSSendPanel.getForm();Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin=new WXTL.Widgets.CommonWindows.Window({title:"按企业通讯录发送",width:950,heigth:600,mainForm:SMSSendPanel.getForm(),needButtons:false,closeAction:'hide',updateURL:Js.Center.SendSMS.SmsContentUpdateURL,displayStore:Js.Center.SendSMS.Send.DisplayStore,updateState:true,updateRecord:row,items:[SMSSendPanel],buttons:[{text:"提交发送",minWidth:70,handler:function(){Js.Center.SendSMS.Sendbyenterprise.func.saveSMS("submit")}},{text:"保存",minWidth:70,handler:function(){Js.Center.SendSMS.Sendbyenterprise.func.saveSMS("save")}},{text:"重置",minWidth:70,qtip:"重置数据",handler:function(){var row=Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin.updateRecord;if(row!=null){SMSSendPanel.getForm().reset();SMSSendPanel.getForm().loadRecord(row);if(row.data.vc2content.indexOf(USERIOGRAPH)>-1){Ext.getCmp("Js.Center.SendSMS.Sendbyenterprise.SendSMSContent").setValue(row.data.vc2content.replace(USERIOGRAPH,''));document.getElementById("Js.Center.SendSMS.Sendbyenterprise.cbk").checked=true;Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(true)}else{Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(false)}}else{SMSSendPanel.getForm().reset();document.getElementById("Js.Center.SendSMS.Sendbyenterprise.cbk").checked=false;Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(false)}}},{text:"取消",minWidth:70,qtip:"取消",handler:function(){Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin.hide();SMSSendPanel.getForm().reset()}}],listeners:{"show":function(){Js.Center.Common.ProductStore.reload();EmployeeTree.root.reload();EmployeeTree.expandAll()},"beforehide":function(){SMSSendPanel.getForm().reset();document.getElementById("Js.Center.SendSMS.Sendbyenterprise.cbk").checked=false;Js.Center.SendSMS.Sendbyenterprise.func.toggleChkGraph(false)}}})}if(show){Js.Center.SendSMS.Sendbyenterprise.SMSsendInfoWin.show()}};Ext.namespace('Js.Center.SendSMS.SMSDelete');Js.Center.SendSMS.SMSDelete.func=function(row){var deleteSplit="";if(row!=null){deleteSplit=row};var params={ids:deleteSplit,flag:"delete"};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.Send.DisplayStore)};Ext.namespace('Js.Center.SendSMS.SMSsend');Js.Center.SendSMS.SMSsend.func=function(show,row){var testFormat="32";var LOCALUSERIOGRAPHSIZE=0;IDIOGRAPH=Js.Center.Common.userSignature;if(Ext.get("SMSSendPanel")==null){var activeTabPanel;Js.Center.SendSMS.SMSsend.UserGroupStore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.Business.YXTUserGroupURL,method:"POST"}),reader:new Ext.data.JsonReader({totalProperty:'totalProperty',root:'data',fields:[{name:'id'},{name:'name'},{name:'boxLabel',mapping:"vc2usergroupname"},{name:'inputValue',mapping:"numusergroupid"},{name:'checked'}]}),baseParams:{flag:"selectallbyprodid",prodId:"",columnlist:"numusergroupid,vc2usergroupname"}});var groupPanel=new WXTL.Widgets.CommonPanel.CheckBoxGroupPanel({store:Js.Center.SendSMS.SMSsend.UserGroupStore,defaultItemsName:'numusergroupid',defaultItemsboxLable:'对不起，没有相关客户组信息。',style:"padding:5px 5px 5px 5px",id:"Js.Center.SendSMS.SMSsend.remoteCheckboxGroup",numcolumns:3,blankText:"请选择客户组",allowBlank:false,name:"客户组："});var productCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"numproductid",hiddenName:"numproductid",id:'Js.Center.SendSMS.SMSsend.SMSnumproductid',emptyText:"-=请选择=-",allowBlank:false,blankText:"请选择通道组",fieldLabel:"<font color=red>选择通道组</font>",mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",isNeedDefaultChoose:false,store:Js.Center.Common.ProductStore,initDefault:function(o){Js.Center.SendSMS.SMSsend.obj=this;o.on("blur",function(){Js.Center.SendSMS.SMSsend.count=o.store.getCount();if(Js.Center.SendSMS.SMSsend.count>0){return true}else{o.setValue('');return false}});o.on('beforequery',function(e){Js.Center.SendSMS.SMSsend.combo=e.combo;if(!e.forceAll){var input=Js.Center.SendSMS.SMSsend.combo.getRawValue();var regExp=new RegExp(".*"+input+".*");Js.Center.SendSMS.SMSsend.combo.store.filterBy(function(record,id){var text=record.get(Js.Center.SendSMS.SMSsend.combo.displayField);return regExp.test(text)});Js.Center.SendSMS.SMSsend.combo.expand();return false}});this.store.on("load",function(a){if(a.data.length==1){Js.Center.SendSMS.SMSsend.obj.setValue(a.data.items[0].id);Js.Center.SendSMS.SMSsend.obj.fireEvent('select',Js.Center.SendSMS.SMSsend.obj,a.data.items[0])}else if(a.data.length==2){if(a.data.items[0].data.numprodid==''){Js.Center.SendSMS.SMSsend.obj.setValue(a.data.items[1].id);Js.Center.SendSMS.SMSsend.obj.fireEvent('select',Js.Center.SendSMS.SMSsend.obj,a.data.items[1])}}})},initComponent:function(){this.addEvents('select','expand','collapse','beforeselect');this.initDefault(this);WXTL.Widgets.CommonForm.ComboBox.superclass.initComponent.call(this);this.on("keyup",function(f,e){this.doQuery()})},listeners:{'select':function(combox,record,numidex){var productId=record.data.numprodid;Js.Center.SendSMS.SMSsend.UserGroupStore.baseParams={flag:"selectallbyprodid",prodId:productId};Js.Center.SendSMS.SMSsend.UserGroupStore.reload()}}});var smsContent=new WXTL.Widgets.CommonForm.Textarea({name:'textContent',id:"Js.Center.SendSMS.SMSsend.SendSMSContent",labelText:"平台签名："+IDIOGRAPH,fieldLabel:'<font color=red>短信内容</font>',contentMaxLength:420-IDIOGRAPHSIZE-Js.Center.Common.userSignature.length,textareaConfig:{allowBlank:false,autocomplete:'on',blankText:"请输入短信内容",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText}});var smsSendContentDiy=new Ext.Panel({id:'Js.Center.SendSMS.SMSsend.SMSSendContentDiy',frame:true,labelWidth:95,border:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 0px;',anchor:'100%'},items:[{columnWidth:.88,layout:'form',border:false,defaults:{anchor:'96%'},items:[smsContent]},{columnWidth:.12,layout:'form',border:false,items:[{xtype:'button',text:'使用模板',handler:function(){Js.Center.SendSMS.SMSTemplateinfo.func(0);Js.Center.SendSMS.SMSTemplateinfo.Window.setPosition(200,80)}}]}]},{xtype:'hidden',name:'numreftime',id:'Js.Center.SendSMS.SMSsend.numreftime'},{xtype:'hidden',name:'vc2content',id:'Js.Center.SendSMS.SMSsend.smscontent'}]});var smsFieldSet=new Ext.form.FieldSet({title:'短信内容',collapsible:false,autoHeight:true,defaultType:'textfield',style:Ext.isIE?'padding:5px 0 0 10px;':'padding:0 0 0 10px;',layout:'form',items:[{xtype:"radiogroup",fieldLabel:"<font color=red>短信模式</font>",allowBlank:true,horizontal:true,defaultValue:'true',items:[{boxLabel:getHelpMsg("长短信",false,'1、内容长度须小于等于420字，其中包括平台签名长度'),inputValue:'32',name:'nummessageformat',checked:true,listeners:{"check":function(checkbox,checked){if(checked){smsContent.contentMaxLength=420-LOCALUSERIOGRAPHSIZE-Js.Center.Common.userSignature.length;Js.Center.SendSMS.SMSsend.nummessageformatName="长短信";testFormat="32"}}}},{boxLabel:getHelpMsg("WapPush",true,'1、内容长度须小于等于115字。<br>2、短信格式如：<font color=red>短信内容|wap地址</font>'),inputValue:'31',name:'nummessageformat',listeners:{"check":function(checkbox,checked){if(checked){smsContent.contentMaxLength=115-LOCALUSERIOGRAPHSIZE;Js.Center.SendSMS.SMSsend.nummessageformatName="WapPush";testFormat="31"}}}}]},{xtype:'hidden',name:'flag',id:'sendflag',fieldLabel:'<font color=red>操作类型</font>'},{xtype:'hidden',name:'numcontentid',fieldLabel:'短信内容编号'},{xtype:'hidden',name:'vc2signature',value:IDIOGRAPH,readOnly:true,fieldLabel:'<font color=red>账户签名</font>'},smsSendContentDiy,{xtype:"radiogroup",fieldLabel:"<font color=red>发送方式</font>",allowBlank:true,horizontal:true,defaultValue:'true',value:'1',items:[{boxLabel:'立即发送',name:"numsendmethod",inputValue:'1',checked:true,listeners:{"check":function(checkbox,checked){if(checked){Js.Center.SendSMS.SMSsend.columnSMSsendMethod="立即发送"}}}},{boxLabel:'定时发送',name:"numsendmethod",inputValue:'2',listeners:{"check":function(checkbox,checked){if(checked){Js.Center.SendSMS.SMSsend.columnSMSsendMethod="定时发送"}}}}]},{xtype:'xDateTime',fieldLabel:'发送时间',name:"datsend",id:"datsend",timeFormat:'H:i:s',value:WXTL.Common.dateTime.getNow(),timeConfig:{altFormats:'H:i:s',allowBlank:true,invalidText:'{0} 是无效的时间-必须符合格式为：H:i:s'},dateFormat:'Y-m-d',dateConfig:{altFormats:'Y-m-d',allowBlank:true}}]});var smsSendTestPanel=new Ext.Panel({frame:true,labelWidth:80,border:false,bodyBorder:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 5px;',anchor:'90%'},items:[{columnWidth:.7,layout:'form',border:false,defaults:{anchor:'90%'},items:[{xtype:"textfield",name:"vc2mobile",value:Js.Center.Common.userMobile,id:"SMSsendtestmobile",fieldLabel:"测试手机号",validator:function(value){var regex=new RegExp(WXTL.Common.regex.Mobile);if(value.indexOf(',')>-1){var list=value.split(',');if(list.length>5){return false}for(var i=0;i<list.length;i++){if(!regex.test(list[i])){return false}}return true}else{return regex.test(value)}},invalidText:'手机号码格式不正确，最多可输入5个用半角逗号隔开的手机号码'}]},{columnWidth:.3,layout:'form',border:false,items:[{xtype:'button',id:'SMSsendtestbtnsendtest',text:'发送测试短信',handler:function(){if(!Ext.getCmp("Js.Center.SendSMS.SMSsend.SendSMSContent").isValid()){return}if(typeof(smsFieldSet)!="undefined"&&"31"==smsFieldSet.items.items[0].getValue()){var contentlength=Ext.getCmp('Js.Center.SendSMS.SMSsend.SendSMSContent').getValue().replace(/[^\x00-\xff]/g,'***').length;var checklength=115-contentlength;if(checklength<0){Ext.Msg.alert("温馨提示","您输入的字数超出限制!");return}}if(Ext.get("SMSsendtestmobile").getValue()==""){Ext.Msg.alert("温馨提示","请输入测试手机号码!")}else{if(productCombox.isValid()&&smsContent.isValid()&&Ext.getCmp("SMSsendtestmobile").isValid()){if(Ext.get("sendflag")!=null)Ext.get("sendflag").dom.value="sendtest";Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var parms={flag:'sendtest',vc2mobile:Ext.get("SMSsendtestmobile").dom.value,numclassid:'0',vc2content:smsContent.getValue(),numproductid:productCombox.getValue(),vc2signature:IDIOGRAPH,nummessageformat:testFormat,datsend:Ext.get("datsend").dom.value};doAjax(Js.Center.SendSMS.YXTSmsContentSubmitURL,parms,Js.Center.SendSMS.Send.DisplayStore)}}}}]}]}]});var SMSSendPanel=new Ext.FormPanel({id:"SMSSendPanel",fileUpload:true,labelAlign:'left',frame:true,style:"background-color:#e7e8f0",defaults:{msgTarget:"side"},items:[{items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",items:[productCombox]}]}]},{xtype:'tabpanel',layoutOnTabChange:true,plain:true,activeTab:0,height:125,items:[{title:'按客户组发送',autoScroll:true,layout:'form',defaultType:'textfield',id:"sendbyusergroup",items:[{xtype:'hidden',fieldLabel:"发送方式 1、栏目 2、客户组 3、持仓股票 4、文件  5、手机号码",name:'numsendtype',id:'sendnumsendtype',value:'sendbyusergroup'},groupPanel]},{title:'按文件发送',layout:'form',id:"sendbyfile",defaultType:'textfield',bodyStyle:'padding:5px 0 0 5px;',items:[{xtype:'fileuploadfield',name:'mobilefile',fieldLabel:getHelpMsg("文件",true,"1、文件格式为txt<br>2、客户端文件请选择小于4M的文件；<br>3、内容格式:　<img src=jspack/product/common/Images/help/mobilefile.jpg align=top/>"),allowBlank:false,blankText:"请选择上传文件",width:480,validator:function(){var filePath=mainForm.items.items[2].getValue();if(filePath!=''){mainForm.items.items[3].el.dom.value=getFileMessage(filePath);document.getElementById("Js.Center.SendSMS.SMSsend.ClientFileName").value=escape(filePath);if(checkFile(filePath)!=''){this.invalidText=checkFile(filePath);return false}else{return true}}else return false}},{xtype:'textarea',name:'filemessage',fieldLabel:'文件信息',readOnly:true,width:480,height:58},{xtype:'hidden',name:'vc2clientfilename',id:"Js.Center.SendSMS.SMSsend.ClientFileName"},{xtype:'hidden',name:'vc2loadfilename',value:''}]},{title:'按输入号码发送',id:"sendbylist",layout:'form',bodyStyle:'padding:5px 0 0 5px;',items:[{xtype:'textarea',name:'mobilelist',id:'SMSmobilelist',allowBlank:false,blankText:"请输入手机号码列表",fieldLabel:WXTL.Common.help.MOBILELIST,width:300,height:80,maxLength:13000,maxLengthText:"请将输入内容控制在1000行以内！",validator:function(value){return checkMobileList(value,1000)}}]}],listeners:{"tabchange":function(TabPanel,Panel){activeTabPanel=TabPanel.getActiveTab();Js.Center.SendSMS.SMSsend.sendtypename=Panel.title;if(Ext.get("sendnumsendtype")!=null){Ext.get("sendnumsendtype").dom.value=Panel.id}}}},smsFieldSet,smsSendTestPanel]});var mainForm=SMSSendPanel.getForm();Js.Center.SendSMS.SMSsend.SMSsendInfoWin=new WXTL.Widgets.CommonWindows.Window({title:"发送短信",mainForm:SMSSendPanel.getForm(),needButtons:false,closeAction:'hide',updateURL:Js.Center.SendSMS.SmsContentUpdateURL,displayStore:Js.Center.SendSMS.Send.DisplayStore,updateState:true,updateRecord:row,items:[SMSSendPanel],buttons:[new Ext.Button({text:'提交发送',minWidth:70,handler:function(){Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateURL=Js.Center.SendSMS.YXTSmsContentSubmitURL;Js.Center.SendSMS.SMSsend.saveSMS("submit");}}),new Ext.Button({text:'保存',minWidth:70,handler:function(){Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateURL=Js.Center.SendSMS.YXTSmsContentSubmitURL;Js.Center.SendSMS.SMSsend.saveSMS("save")}}),new Ext.Button({text:'重置',minWidth:70,qtip:"重置数据",handler:function(){if(Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord!=null){SMSSendPanel.getForm().reset();groupPanel.reset();SMSSendPanel.getForm().loadRecord(Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord);Ext.getCmp('Js.Center.SendSMS.SMSsend.smscontent').setValue(Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord.data.vc2content)}else{SMSSendPanel.getForm().reset();groupPanel.reset()}SMSSendPanel.items.items[1].setActiveTab(0)}}),new Ext.Button({text:'取消',minWidth:70,handler:function(){Js.Center.SendSMS.SMSsend.UserGroupStore.baseParams={flag:"selectallbyprodid",prodId:""};Js.Center.SendSMS.SMSsend.UserGroupStore.reload();Js.Center.SendSMS.SMSsend.SMSsendInfoWin.hide();SMSSendPanel.getForm().reset();groupPanel.reset()}})],listeners:{"show":function(){Js.Center.Common.ProductStore.reload({params:{vc2servicetype:'1'}});Js.Center.SendSMS.SMSsend.UserGroupStore.reload({callback:function(){}});},"beforehide":function(){Js.Center.SendSMS.SMSsend.SMSsendInfoWin.mainForm.reset();groupPanel.reset();SMSSendPanel.items.items[1].setActiveTab(0);productCombox.store.removeAll()}}})}else{Js.Center.SendSMS.SMSsend.SMSsendInfoWin.mainForm.items.each(function(f){if(f.xtype!=null)f.reset();else{f.df.reset()}});Js.Center.SendSMS.SMSsend.SMSsendInfoWin.updateRecord=row};var isSelfValid=function(){var valid=true;var panel=Js.Center.SendSMS.SMSsend.SMSsendInfoWin.items.items[0].items.items[1].getActiveTab();if(!Js.Center.SendSMS.SMSsend.SMSsendInfoWin.mainForm.items.items[0].isValid()){valid=false;return valid}if(!Ext.getCmp("Js.Center.SendSMS.SMSsend.SendSMSContent").isValid()){valid=false;return valid}if("31"==smsFieldSet.items.items[0].getValue()){var contentlength=Ext.getCmp('Js.Center.SendSMS.SMSsend.SendSMSContent').getValue().replace(/[^\x00-\xff]/g,'***').length;var checklength=115-contentlength;if(checklength<0){Ext.Msg.alert("温馨提示","您输入的字数超出限制!");valid=false;return valid}}panel.items.each(function(f){if(panel.id=="sendbyusergroup"){if(f.xtype!="hidden"){if(!f.items.items[1].validate()){valid=false;return false}}}else{if(f.xtype=="UploadLargeFilePanel"){if(!f.items.items[0].items.items[2].items.items[0].validate()){valid=false;return false}if(!f.items.items[0].items.items[0].items.items[2].validate()){valid=false;return false}}else{if(!f.validate()){valid=false;return false}}}});Js.Center.SendSMS.SMSsend.SMSsendInfoWin.items.items[0].items.items[2].items.each(function(f){if(f.id!="Js.Center.SendSMS.SMSsend.SMSSendContentDiy"){if(f.id!="SMSsendbtnsendtest"){if(!f.validate()){valid=false;return valid}}}});if(!checkSMSFilingSign(productCombox.getValue(),smsContent.getValue())){valid=false};return valid};var sendSMSReview=function(){mainForm.valid=true;if(isSelfValid(activeTabPanel)){if(Js.Center.SendSMS.SMSsend.columnSMSsendMethod=="立即发送"){Js.Center.SendSMS.SMSsend.columnSMSsendDatetime=""}if(Js.Center.SendSMS.SMSsend.columnSMSsendMethod=="定时发送"){Js.Center.SendSMS.SMSsend.columnSMSsendDatetime=Ext.get("datsend-date").getValue()+' '+Ext.get("datsend-time").getValue()}Js.Center.SendSMS.SMSsend.columnSMScontent=smsFieldSet.items.items[6].getValue()+IDIOGRAPH;Js.Center.SendSMS.SMSsend.saveSMS("submit")}};Js.Center.SendSMS.SMSsend.saveSMS=function(method){Ext.getCmp('Js.Center.SendSMS.SMSsend.smscontent').setValue(Ext.getCmp("Js.Center.SendSMS.SMSsend.SendSMSContent").getValue());if(Ext.get("sendflag")!=null)Ext.get("sendflag").dom.value=method;Js.Center.SendSMS.SMSsend.SMSsendInfoWin.mainForm.valid=true;if(isSelfValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Js.Center.SendSMS.SMSsend.SMSsendInfoWin.mainFormSubmitFunc()}};if(show){Js.Center.SendSMS.SMSsend.SMSsendInfoWin.show()}};Ext.namespace('Js.Center.SendSMS.SMSsenddiy');Js.Center.SendSMS.SMSsenddiy.func=function(show,row){var testFormat="15";IDIOGRAPH=Js.Center.Common.userSignature;if(Ext.get("SMSSenddiyPanelDiy")==null){var productCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"numproductid",hiddenName:"numproductid",id:'SMSnumproductiddiy',emptyText:"-=请选择=-",allowBlank:false,blankText:"请选择通道组",fieldLabel:"<font color=red>选择通道组</font>",mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:Js.Center.Common.ProductStore,initDefault:function(o){Js.Center.SendSMS.SMSsenddiy.obj=this;o.on("blur",function(){Js.Center.SendSMS.SMSsenddiySsend.count=o.store.getCount();if(Js.Center.SendSMS.SMSsenddiy.count>0){return true}else{o.setValue('');return false}});o.on('beforequery',function(e){Js.Center.SendSMS.SMSsenddiy.combo=e.combo;if(!e.forceAll){var input=Js.Center.SendSMS.SMSsenddiy.combo.getRawValue();var regExp=new RegExp(".*"+input+".*");Js.Center.SendSMS.SMSsenddiy.combo.store.filterBy(function(record,id){var text=record.get(Js.Center.SendSMS.SMSsenddiy.combo.displayField);return regExp.test(text)});Js.Center.SendSMS.SMSsenddiy.combo.expand();return false}});this.store.on("load",function(a){if(a.data.length==1){Js.Center.SendSMS.SMSsenddiy.obj.setValue(a.data.items[0].id);}else if(a.data.length==2){if(a.data.items[0].data.numprodid==''){Js.Center.SendSMS.SMSsenddiy.obj.setValue(a.data.items[1].id);}}})},initComponent:function(){this.addEvents('select','expand','collapse','beforeselect');this.initDefault(this);WXTL.Widgets.CommonForm.ComboBox.superclass.initComponent.call(this);this.on("keyup",function(f,e){this.doQuery()})}});Js.Center.Common.ProductStore.load({params:{vc2servicetype:'1'}});var smsContentdiy=new WXTL.Widgets.CommonForm.Textarea({id:"Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy",labelText:"平台签名："+IDIOGRAPH,fieldLabel:getHelpMsg("短信模板内容",true,'1、内容长度须小于等于420字，其中包括平台签名长度<br>2、平台签名所占长度为'+IDIOGRAPHSIZE+'个字。<br>3、您可以输入的长度为'+(420-IDIOGRAPHSIZE)+'个字。<br>4、内容格式：<br>${v0}:您好，您${v1}当日净值为${v2}元'),contentMaxLength:420-IDIOGRAPHSIZE,textareaConfig:{allowBlank:false,autocomplete:'on',regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText,blankText:"请输入短信模板内容"}});var smsFieldSetDiy=new Ext.form.FieldSet({collapsible:false,autoHeight:true,defaultType:'textfield',style:Ext.isIE?'padding:5px 0 0 10px;':'padding:0 0 0 10px;',layout:'form',items:[{xtype:'hidden',name:'nummessageformat',value:'34'},{xtype:'hidden',name:'flag',id:'sendflagdiy',fieldLabel:'<font color=red>操作类型</font>'},{xtype:'hidden',name:'numcontentid',fieldLabel:'短信内容编号'},{xtype:'hidden',name:'vc2content',id:'Js.Center.SendSMS.SMSsenddiy.smscontent'},{xtype:'hidden',name:'vc2signature',value:IDIOGRAPH,readOnly:true,fieldLabel:'<font color=red>账户签名</font>'},{xtype:'hidden',name:'numsendtype',id:'updatesendtype',value:'sendbyfilediy'},{xtype:'hidden',name:'numreftime',id:'Js.Center.SendSMS.SMSsenddiy.numreftime'},{xtype:"radiogroup",fieldLabel:"<font color=red>发送方式</font>",allowBlank:true,horizontal:true,defaultValue:'true',value:'1',items:[{boxLabel:'立即发送',name:"numsendmethod",inputValue:'1',checked:true,listeners:{"check":function(checkbox,checked){if(checked){Js.Center.SendSMS.SMSsenddiy.columnSMSsendMethod="立即发送"}}}},{boxLabel:'定时发送',name:"numsendmethod",inputValue:'2',listeners:{"check":function(checkbox,checked){if(checked){Js.Center.SendSMS.SMSsenddiy.columnSMSsendMethod="定时发送"}}}}]},{xtype:'xDateTime',fieldLabel:'发送时间',name:"datsend",id:"datsenddiy",timeFormat:'H:i:s',value:WXTL.Common.dateTime.getNow(),timeConfig:{altFormats:'H:i:s',allowBlank:true,invalidText:'{0} 是无效的时间-必须符合格式为：H:i:s'},dateFormat:'Y-m-d',dateConfig:{altFormats:'Y-m-d',allowBlank:true}}]});var smsSendTestPanelDiy=new Ext.Panel({frame:true,labelWidth:80,border:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 5px;',anchor:'100%'},items:[{columnWidth:.6,layout:'form',border:false,defaults:{anchor:'90%'},items:[{xtype:"textfield",name:"vc2mobile",value:Js.Center.Common.userMobile,id:"SMSsendtestmobilediy",fieldLabel:"测试手机号"}]},{columnWidth:.4,layout:'form',border:false,items:[{xtype:'button',id:'SMSsenddiytestbtnsendtest',text:'发送测试短信',allowBlank:false,handler:function(){if(Ext.get("SMSsendtestmobilediy").getValue()==""){Ext.Msg.alert("温馨提示","请输入测试手机号码!")}else{if(productCombox.isValid()&&smsContentdiy.isValid()){if(Ext.get("sendflag")!=null)Ext.get("sendflag").dom.value="sendtest";Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var parms={flag:'sendtestdiy',vc2mobile:Ext.get("SMSsendtestmobilediy").dom.value,numclassid:'0',vc2content:smsContentdiy.getValue(),numproductid:productCombox.getValue(),vc2signature:IDIOGRAPH,nummessageformat:34,datsend:Ext.get("datsenddiy").dom.value};doAjax(Js.Center.SendSMS.YXTSmsContentSubmitURL,parms)}}}}]}]}]});var smsSendContentPanelDiy=new Ext.Panel({frame:true,labelWidth:95,border:false,items:[{layout:'column',defaults:{bodyStyle:'padding:0px 0 0 0px;',anchor:'100%'},items:[{columnWidth:.88,layout:'form',border:false,defaults:{anchor:'96%'},items:[smsContentdiy]},{columnWidth:.12,layout:'form',border:false,items:[{xtype:'button',text:'使用模板',handler:function(){Js.Center.SendSMS.SMSTemplateinfo.func(1);Js.Center.SendSMS.SMSTemplateinfo.Window.setPosition(200,80)}}]}]}]});var SMSSenddiyPanelDiy=new Ext.FormPanel({id:"SMSSenddiyPanelDiy",fileUpload:true,labelAlign:'left',frame:true,style:"background-color:#e7e8f0",defaults:{msgTarget:"side"},items:[{items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",items:[productCombox]}]}]},{layout:'form',id:"sendbyfile",defaultType:'textfield',items:[{xtype:'fileuploadfield',name:'mobilefile',fieldLabel:getHelpMsg("文件",true,"1.上传的文件扩展名必须是txt<br>2.支持客户端文件,客户端文件大小最大限制为4M<br>3.个性化内容的格式是:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;13888776655|[&quot李先生&quot,&quot富国天益&quot,&quot 1.003&quot]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;13888776655|[&quot刘先生&quot,&quot华夏成长&quot,&quot 1.173&quot]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;13888776655|[&quot赵先生&quot,&quot富国天益&quot,&quot 1.003&quot]"),allowBlank:false,blankText:"请选择上传文件",width:480,validator:function(){var filePath=mainForm.items.items[1].getValue();if(filePath!=''){mainForm.items.items[2].el.dom.value=getFileMessage(filePath);document.getElementById("Js.Center.SendSMS.SMSsenddiy.ClientFileName").value=escape(filePath);if(checkFile(filePath)!=''){this.invalidText=checkFile(filePath);return false}else{return true}}else return false}},{xtype:'textarea',name:'filemessage',fieldLabel:'文件信息',readOnly:true,width:480,height:58},{xtype:'hidden',name:'vc2clientfilename',id:"Js.Center.SendSMS.SMSsenddiy.ClientFileName"},{xtype:'hidden',name:'vc2loadfilename',value:''}]},smsSendContentPanelDiy,smsFieldSetDiy,smsSendTestPanelDiy]});var mainForm=SMSSenddiyPanelDiy.getForm();Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin=new WXTL.Widgets.CommonWindows.Window({title:"发送个性化短信",mainForm:SMSSenddiyPanelDiy.getForm(),needButtons:false,updateURL:Js.Center.SendSMS.YXTSmsContentSubmitURL,displayStore:Js.Center.SendSMS.Send.DisplayStore,closeAction:'hide',updateState:true,updateRecord:row,items:[SMSSenddiyPanelDiy],buttons:[new Ext.Button({text:'提交发送',minWidth:70,handler:function(){Ext.get("updatesendtype").dom.value="sendbyfilediy";Js.Center.SendSMS.SMSsenddiy.saveSMS("submit")}}),new Ext.Button({text:'重置',minWidth:70,qtip:"重置数据",handler:function(){if(Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord!=null){SMSSenddiyPanelDiy.getForm().reset();SMSSenddiyPanelDiy.getForm().loadRecord(Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord);Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").setValue(Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord.data.vc2content)}else{SMSSenddiyPanelDiy.getForm().reset();}}}),new Ext.Button({text:'取消',minWidth:70,handler:function(){Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.hide();SMSSenddiyPanelDiy.getForm().reset()}})],listeners:{"show":function(){Js.Center.Common.ProductStore.reload({params:{vc2servicetype:'1'}});},"beforehide":function(){Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.mainForm.reset();productCombox.store.removeAll();}}})}else{Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.mainForm.items.each(function(f){if(f.xtype!=null)f.reset();else{f.df.reset()}});Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.updateRecord=row};var isSelfValid=function(method){var valid=true;if(method=="submit"){if(!Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.mainForm.items.items[0].isValid()){valid=false}if(!mainForm.items.items[1].validate()){return false}if(!mainForm.items.items[2].validate()){return false}if(!Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").isValid())valid=false}else if(method=="sendtest"){if(!Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").isValid())valid=false;}if(!checkSMSFilingSign(productCombox.getValue(),smsContentdiy.getValue())){valid=false}return valid};Js.Center.SendSMS.SMSsenddiy.saveSMS=function(method){if(Ext.get("sendflagdiy")!=null)Ext.get("sendflagdiy").dom.value=method;Ext.getCmp('Js.Center.SendSMS.SMSsenddiy.smscontent').setValue(Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").getValue());if(isSelfValid(method)){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.mainFormSubmitFunc()}};if(show!=null){if(show!=false){Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.show()}}else{Js.Center.SendSMS.SMSsenddiy.SMSsendInfoWin.show()}};Ext.namespace('Js.Center.SendSMS.SMSTemplateinfo');Js.Center.SendSMS.SMSTemplateinfo.func=function(status){var _pageSize=12;Js.Center.SendSMS.SMSTemplateinfo._status=status;Js.Center.SendSMS.SMSTemplateinfo.doDelete=function(){var row=SMSTemplateinfoGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("温馨提示","请您选择记录!")}else{var numtype=row[0].data.numtype;var deleteSplit="";for(var i=0;i<row.length;i++){if(row.length==1){deleteSplit=row[i].data.numtemplateid}else{if(i<(row.length-1)){deleteSplit=row[i].data.numtemplateid+","+deleteSplit}if(i==(row.length-1)){deleteSplit=deleteSplit+row[i].data.numtemplateid}}};var params={numtemplateid:deleteSplit,flag:"deletetemplate"};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.SMSTemplateinfo.Infostore)}};var SMSTemplsteSelectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({id:"SMSTemplsteSelectPanel",height:100,queryMethod:"Js.Center.SendSMS.SMSTemplateinfo.queryGrid",items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[{xtype:"textfield",id:"templatecontent",fieldLabel:"模板内容",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50}]}]}]});Js.Center.SendSMS.SMSTemplateinfo.queryGrid=function(){if(SMSTemplsteSelectPanel.getForm().isValid()){var _templateContent=Ext.get("templatecontent").getValue();Js.Center.SendSMS.SMSTemplateinfo.Infostore.baseParams={content:_templateContent,flag:'selecttemplate'};Js.Center.SendSMS.SMSTemplateinfo.Infostore.load({params:{start:0,limit:_pageSize}})}};var fields=["numtemplateid","vc2content","vc2username","vc2departname","datcreatetime","numreftime"];Js.Center.SendSMS.SMSTemplateinfo.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.SmsContentURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:fields,root:"data",id:"numtemplateid",totalProperty:"totalCount"}),sortInfo:{field:'numtemplateid',direction:'DESC'},baseParams:{content:'',selectType:status,flag:'selecttemplate'}});Js.Center.SendSMS.SMSTemplateinfo.Infostore.load({params:{start:0,limit:_pageSize}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numusergroupid"});var cm=new Ext.grid.ColumnModel([{hidden:true,dataIndex:"numtemplateid",sortable:true},{header:"模板内容",tooltip:"模板内容",dataIndex:"vc2content",sortable:true},{header:"修改人",tooltip:"修改人",dataIndex:"vc2username",sortable:true},{header:"部门",tooltip:"部门",dataIndex:"vc2departname"},{header:"修改时间",tooltip:"修改时间",dataIndex:"datcreatetime",sortable:true},{header:"引用次数",dataIndex:"numreftime",sortable:true}]);var SMSTemplateinfoGrid=new WXTL.Widgets.CommonGrid.GridPanelOriginal({title:"",anchor:'100% 100%',pageSize:_pageSize,store:Js.Center.SendSMS.SMSTemplateinfo.Infostore,needMenu:true,needRightMenu:false,sm:sm,cm:cm,afterEditURL:Js.Center.SendSMS.SmsContentUpdateURL,inertMethod:'Js.Center.SendSMS.SMSTemplateinsert.func',updateMethod:'Js.Center.SendSMS.SMSTemplateupdate.func',deleteMethod:'Js.Center.SendSMS.SMSTemplateinfo.doDelete'});var mainPanel=new Ext.form.FormPanel({frame:true,bodyBorder:false,border:false,autoScroll:true,layout:"anchor",width:650,defaults:{collapsible:true},items:[SMSTemplateinfoGrid]});var mainForm=mainPanel.getForm();Js.Center.SendSMS.SMSTemplateinfo.Window=new WXTL.Widgets.CommonWindows.WindowOriginal({title:"短信模板",mainForm:mainForm,closeAction:'close',updateURL:Js.Center.Business.UserGroupUpdateURL,displayStore:Js.Center.SendSMS.SMSTemplateinfo.Infostore,updateState:true,items:[SMSTemplsteSelectPanel,mainPanel],needButtons:false,buttons:[{text:"使 用",minWidth:70,handler:function(){var row=SMSTemplateinfoGrid.getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("温馨提示","请您选择记录!")}else{if(status==1){Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiy").setValue(row[0].data.vc2content);Ext.getCmp("Js.Center.SendSMS.SMSsenddiy.numreftime").setValue(row[0].data.numtemplateid);Ext.get("Js.Center.SendSMS.SMSsenddiy.SendSMSContentdiyfontsize").dom.innerHTML="字数:"+row[0].data.vc2content.length}else{Ext.getCmp("Js.Center.SendSMS.SMSsend.SendSMSContent").setValue(row[0].data.vc2content);Ext.getCmp("Js.Center.SendSMS.SMSsend.numreftime").setValue(row[0].data.numtemplateid);Ext.get("Js.Center.SendSMS.SMSsend.SendSMSContentfontsize").dom.innerHTML="字数:"+row[0].data.vc2content.length;}Js.Center.SendSMS.SMSTemplateinfo.Window.close()}}},{text:"关  闭",minWidth:70,handler:function(){Js.Center.SendSMS.SMSTemplateinfo.Window.close()}}]});Js.Center.SendSMS.SMSTemplateinfo.Window.show()};Ext.namespace('Js.Center.SendSMS.SMSTemplateinsert');Ext.QuickTips.init();Js.Center.SendSMS.SMSTemplateinsert.func=function(){var templateType=Js.Center.SendSMS.SMSTemplateinfo._status;var SMSTemplateinsertInfofp=new Ext.form.FormPanel({frame:true,labelWidth:80,defaults:{anchor:'90%',msgTarget:'side'},items:[{xtype:"hidden",name:"flag",value:"inserttemplate"},{xtype:"textarea",name:"vc2content",id:"Js.Center.SendSMS.SMSTemplateinsert.Textarea",fieldLabel:check(),allowBlank:false,blankText:"模板内容不允许为空！",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText,height:100,maxLength:lengthChange()}]});var mainForm=SMSTemplateinsertInfofp.getForm();Js.Center.SendSMS.SMSTemplateinsert.Window=new WXTL.Widgets.CommonWindows.WindowOriginal({title:"添加模板",mainForm:mainForm,updateURL:Js.Center.SendSMS.SmsContentUpdateURL,displayStore:Js.Center.SendSMS.SMSTemplateinfo.Infostore,items:[SMSTemplateinsertInfofp]});function check(){if(templateType==0){return getHelpMsg("模板内容",true,'1、内容长度须小于等于420。<br>2、内容格式：内容格式：x先生您好，您的当日净值为xxxxx元')}else{return getHelpMsg("模板内容",true,'1、内容长度须小于等于420字。<br>2、内容格式：<br>${v0}:您好，您${v1}当日净值为${v2}元')}}function lengthChange(){if(templateType==0){return 420}else{return 420}}Js.Center.SendSMS.SMSTemplateinsert.Window.show()};Ext.namespace('Js.Center.SendSMS.SMSTemplateupdate');Ext.QuickTips.init();Js.Center.SendSMS.SMSTemplateupdate.func=function(row){var templateType=Js.Center.SendSMS.SMSTemplateinfo._status;var SMSTemplateupdateInfofp=new Ext.form.FormPanel({frame:true,labelWidth:80,defaults:{anchor:'90%',msgTarget:'side'},items:[{xtype:"hidden",name:"flag",value:"updatetemplate"},{xtype:"hidden",name:"numtemplateid"},{xtype:"textarea",name:"vc2content",fieldLabel:check(),allowBlank:false,blankText:"模板内容不允许为空！",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText,height:100,maxLength:lengthChange()}]});var mainForm=SMSTemplateupdateInfofp.getForm();Js.Center.SendSMS.SMSTemplateupdate.Window=new WXTL.Widgets.CommonWindows.WindowOriginal({title:"添加模板",mainForm:mainForm,updateURL:Js.Center.SendSMS.SmsContentUpdateURL,displayStore:Js.Center.SendSMS.SMSTemplateinfo.Infostore,updateRecord:row,items:[SMSTemplateupdateInfofp]});function check(){if(templateType==0){return getHelpMsg("模板内容",true,'1、内容长度须小于等于420。<br>2、内容格式：x先生您好，您的当日净值为xxxxx元')}else{return getHelpMsg("模板内容",true,'1、内容长度须小于等于420字。<br>2、内容格式：<br>${v0}:您好，您${v1}当日净值为${v2}元')}}function lengthChange(){if(templateType==0){return 420}else{return 420}}Js.Center.SendSMS.SMSTemplateupdate.Window.show()};Ext.namespace('Js.Center.SendSMS');Js.Center.SendSMS.SmsContentURL='URL/SendSMS/Send/SMSContentQuery.ashx';Js.Center.SendSMS.YXTSmsContentURL='URL/SendSMS/Send/YXTSMSContentQuery.ashx';Js.Center.SendSMS.SmsContentUpdateURL='URL/sendSMS/send/smscontentupdate.ashx';Js.Center.SendSMS.YXTSmsContentSubmitURL='URL/sendSMS/send/yxtsmscontentupdate.ashx';Js.Center.Business.YXTUserGroupURL='URL/Customer/UserGroup/UserGroupQuery.ashx';