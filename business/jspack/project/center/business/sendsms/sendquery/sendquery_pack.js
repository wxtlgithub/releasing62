Ext.namespace('Js.Center.SendSMS.DepartSendDetailsInfo');Ext.QuickTips.init();Js.Center.SendSMS.DepartSendDetailsInfo.func=function(row){Js.Center.SendSMS.DepartSendDetailsInfo.numContentID=row.get("numcontentid");Js.Center.SendSMS.DepartSendDetailsInfo.datSend=row.get("datsend");var setSendtype=function(){var value=row.get("numsendtype");if(value==1){Js.Center.SendSMS.DepartSendDetailsInfo.numType="栏目"}if(value==2){Js.Center.SendSMS.DepartSendDetailsInfo.numType="客户组"}if(value==3){Js.Center.SendSMS.DepartSendDetailsInfo.numType="持仓股票"}if(value==4){Js.Center.SendSMS.DepartSendDetailsInfo.numType="手机号码"}if(value==5){Js.Center.SendSMS.DepartSendDetailsInfo.numType="按文件发送"}};setSendtype();var departSendDetailsInfoPanel=new Ext.form.FormPanel({id:"departSendDetailsInfoPanel",width:700,frame:true,labelWidth:80,defaults:{anchor:"99%"},items:[{xtype:"hidden",name:"numcontentid",fieldLabel:"信息编号"},{xtype:"textfield",name:"vc2creatername",fieldLabel:"发送人",readOnly:true},{xtype:"textfield",name:"numsendtype1",fieldLabel:"发送方式",readOnly:true,value:Js.Center.SendSMS.DepartSendDetailsInfo.numType},{xtype:"textarea",name:"vc2content",fieldLabel:"短信内容",readOnly:true,width:600,height:100}]});var _pageSize=12;var fields=["numsendgroupid","nummtcnt","numrep_succnt","numrep_nocnt","numrep_faicnt","numsuc_rate"];Js.Center.SendSMS.DepartSendDetailsInfo.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.SendQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:fields,root:"data",id:"numsendgroupid",totalProperty:"totalCount"}),sortInfo:{field:'numsendgroupid',direction:'DESC'},baseParams:{flag:'querydetailbycontentid',contentid:Js.Center.SendSMS.DepartSendDetailsInfo.numContentID,datsend:Js.Center.SendSMS.DepartSendDetailsInfo.datSend}});Js.Center.SendSMS.DepartSendDetailsInfo.Infostore.load({params:{start:0,limit:_pageSize,flag:'querydetailbycontentid',contentid:Js.Center.SendSMS.DepartSendDetailsInfo.numContentID,datsend:Js.Center.SendSMS.DepartSendDetailsInfo.datSend}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numsendgroupid"});var cm=new Ext.grid.ColumnModel([{header:"实际发送量",tooltip:"实际发送量",dataIndex:"nummtcnt",sortable:true},{header:"成功量",tooltip:"成功量",dataIndex:"numrep_succnt",sortable:true},{header:"未知状态",tooltip:"未知状态",dataIndex:"numrep_nocnt",sortable:true},{header:"失败量",tooltip:"失败量",dataIndex:"numrep_faicnt",sortable:true},{header:"成功率",tooltip:"成功率",dataIndex:"numsuc_rate",sortable:true,renderer:function(value){if(value=="0.0000"){return"0.00%"}else{var rate=value*100;return Math.round(rate*100)/100+"%"}}},{header:"详情",tooltip:"详情",dataIndex:"numsendgroupid",renderer:function(value,meta,record,rowIndex,colIndex,store){return"<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SendQueryURL+"\",\"contentid="+Js.Center.SendSMS.DepartSendDetailsInfo.numContentID+"&start=0&limit=-1&flag=loadErrorDetails\")'>下载</a>"}}]);var departSendQueryinfoGrid=new WXTL.Widgets.CommonGrid.GridPanel({title:"",anchor:'99% 99%',width:700,pageSize:_pageSize,needMenu:false,store:Js.Center.SendSMS.DepartSendDetailsInfo.Infostore,sm:sm,cm:cm,needRightMenu:false});var gridPanel=new Ext.Panel({width:700,frame:true,bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[departSendQueryinfoGrid]});var departSendDetailsInfoWin=new Ext.Window({title:"查看发送详细信息",width:750,plain:true,iconCls:"addicon",resizable:false,defaultType:"textfield",labelWidth:80,collapsible:true,closeAction:'hide',closable:true,plain:true,modal:'true',buttonAlign:"center",bodyStyle:"padding:10px 0 0 15px",items:[gridPanel,departSendDetailsInfoPanel],listeners:{"show":function(){departSendDetailsInfoPanel.getForm().loadRecord(row)}},buttons:[{text:"关  闭",minWidth:70,handler:function(){departSendDetailsInfoWin.hide()}}]});departSendDetailsInfoWin.show()};Ext.namespace('Js.Center.SendSMS.DepartSendQuery');Js.Center.SendSMS.DepartSendQuery.departSendQueryinfo=function(node){if(Ext.get("Js.Center.SendSMS.DepartSendQuery.departSendQueryinfoPanel")==null){var _pageSize=12;var fields=["numcontentid","numsendplanid","vc2srcmobile","vc2content","vc2serviceid","datrecv","datsend","datcreate","datcheck1","datcheck2","numcreaterid","vc2creatername","numcheck1id","vc2check1name","numcheck2id","vc2check2name","vc2departname","numsendtype","numstate","numprenum","numtotal","numsuccess","numfailed","vc2status","numsendmethod","numprodid"];Js.Center.SendSMS.DepartSendQuery.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.SendQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:fields,root:"data",id:"numcontentid",totalProperty:"totalCount"}),sortInfo:{field:'datcheck2',direction:'DESC'}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numcontentid"});var cm=new Ext.grid.ColumnModel([{header:"内容",tooltip:"内容",dataIndex:"vc2content",sortable:true,width:220,renderer:function(value){return"<font qtip='"+value+"'>"+value+"</font>"},readOnly:true,editor:new Ext.form.TextField({readOnly:true})},{header:"提交日期",tooltip:"提交日期",dataIndex:"datcreate",sortable:true},{header:"发送时间",tooltip:"发送时间",dataIndex:"datsend",sortable:true},{header:"拟发送量",tooltip:"拟发送量",dataIndex:"numprenum",sortable:true},{header:"<font color='green'>合法</font>/<font color='red'>非法</font>",tooltip:"合法/非法",dataIndex:"numcontentid",renderer:function(value,meta,record,rowIndex,colIndex,store){var row=Js.Center.SendSMS.DepartSendQuery.Infostore.getAt(rowIndex);var suc,fail;if(row.get("numsendtype")==2){suc="<font color='green'>"+row.get("numtotal")+"</font>";fail="/<font color='red'>"+row.get("numfailed")+"</font>"}else{suc=row.get("numsuccess")>0?"<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+value+"&flag=selectexport&successtype=1\")'><font color='green'>"+row.get("numsuccess")+"</font></a>":"<font color='green'>"+row.get("numsuccess")+"</font>";fail=row.get("numfailed")>0?"/<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+value+"&flag=selectexport&successtype=0\")'><font color='red'>"+row.get("numfailed")+"</font></a>":"/<font color='red'>"+row.get("numfailed")+"</font>"}return suc+fail}},{header:"发送部门",tooltip:"发送部门",dataIndex:"vc2departname",sortable:true},{header:"发送人",tooltip:"发送人",dataIndex:"vc2creatername",sortable:true},{hidden:true,header:"一审审核人",tooltip:"一审审核人",dataIndex:"vc2check1name",sortable:true},{hidden:true,header:"一审时间",tooltip:"一审时间",dataIndex:"datcheck1",sortable:true},{hidden:true,header:"二审审核人",tooltip:"二审审核人",dataIndex:"vc2check2name",sortable:true},{hidden:true,header:"二审时间",tooltip:"二审时间",dataIndex:"datcheck2",sortable:true},{header:"状态",tooltip:"状态",dataIndex:"numstate",sortable:true,renderer:function(value,meta,record,rowIndex,colIndex,store){var row=Js.Center.SendSMS.DepartSendQuery.Infostore.getAt(rowIndex);if(row.get("vc2status")==2||row.get("vc2status")==99||row.get("vc2status")==-99||row.get("vc2status")==-1){return"审核完成"}else{if(row.get("vc2status")>1000){return"暂停发送"}else if(value==0){return"待审核"}else if(value==1){return"一审完成"}else if(value==2){return"审核完成"}else if(value==3){return"驳回"}else if(value==4){return"正在发送"}else if(value==5){return"发送完成"}}}},{header:"查看详细",tooltip:"查看详细",dataIndex:"numcontentid",width:70,renderer:function(value,meta,record,rowIndex,colIndex,store){if(2==record.get('numsendmethod')&&5!=record.get("numstate")&&2==record.get("numstate")){var type=1;var title="暂停";var content="";if(1000<record.get("vc2status")){type=0;title="继续"}content="<a href='#' onclick='Js.Center.SendSMS.DepartSendQuery.showPause(\""+value+"\")'>操作</a>&nbsp;<a href='#' onclick='Js.Center.SendSMS.DepartSendQuery.doPause(\""+value+"\", "+type+")'>"+title+"</a>";return content}else{return"<a href='#' onclick='Js.Center.SendSMS.DepartSendQuery.print(\""+value+"\")'>详细</a>"}}}]);var departSendQueryinfoGrid=new WXTL.Widgets.CommonGrid.GridPanel({id:"departsendqueryinfoGridPanel",anchor:'100% 100%',pageSize:_pageSize,needMenu:false,store:Js.Center.SendSMS.DepartSendQuery.Infostore,sm:sm,cm:cm,needRightMenu:false});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({id:"departSendQueryinfoSelectPanel",height:160,queryMethod:"Js.Center.SendSMS.DepartSendQuery.queryGrid",items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[new Ext.form.DateField({fieldLabel:'开始时间',name:'datstart',readOnly:true,id:'departsendqueryinfodatstart',emptyText:Ext.util.Format.date(WXTL.Common.dateTime.addDay(WXTL.Common.dateTime.getNow(),-3),'Y-m-d'),format:'Y-m-d',validateOnBlur:false,validator:function(){var strat_time=Ext.get("departsendqueryinfodatstart").dom.value;var end_time=Ext.get("departsendqueryinfodatend").dom.value;if(strat_time<=end_time){return true}else{return false}},invalidText:'结束时间不能小于开始时间！'}),{xtype:"textfield",name:"content",id:'departsendqueryinfodepartname',fieldLabel:"发送部门",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:25,maxLengthText:'长度不能超过25！'},new WXTL.Widgets.CommonForm.ComboBox({xtype:"combo",name:"numprodid",hiddenName:"departsendqueryinfonumprodid",fieldLabel:"通道组",mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:Js.Center.Common.ProductStore})]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[new Ext.form.DateField({fieldLabel:'结束时间',name:'datend',readOnly:true,id:'departsendqueryinfodatend',emptyText:Ext.util.Format.date(WXTL.Common.dateTime.getNow(),'Y-m-d'),format:'Y-m-d',validateOnBlur:false,validator:function(){var strat_time=Ext.get("departsendqueryinfodatstart").dom.value;var end_time=Ext.get("departsendqueryinfodatend").dom.value;if(strat_time<=end_time){return true}else{return false}},invalidText:'结束时间不能小于开始时间！'}),{xtype:"textfield",name:"content",id:'departsendqueryinfousername',fieldLabel:"发送人",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:25,maxLengthText:'长度不能超过25！'},{xtype:"textfield",name:"content",id:'departsendqueryinfocontent',fieldLabel:"内容",regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,maxLength:50,maxLengthText:'长度不能超过50！'}]}]}]});Js.Center.Common.ProductStore.reload({params:{vc2servicetype:'1'}});Js.Center.SendSMS.DepartSendQuery.queryGrid=function(){if(selectPanel.getForm().isValid()){var datStart=Ext.get("departsendqueryinfodatstart").getValue();var datEnd=Ext.get("departsendqueryinfodatend").getValue();var _departmentname=Ext.get("departsendqueryinfodepartname").getValue();var _username=Ext.get("departsendqueryinfousername").getValue();var _numprodid=Ext.get("departsendqueryinfonumprodid").getValue();var content=Ext.get("departsendqueryinfocontent").getValue();var flag='selectbysearchkey';Js.Center.SendSMS.DepartSendQuery.Infostore.baseParams={datstart:datStart,datend:datEnd,numprodid:_numprodid,vc2departmentname:_departmentname,vc2creatername:_username,vc2content:content,flag:flag};Js.Center.SendSMS.DepartSendQuery.Infostore.load({params:{start:0,limit:_pageSize}})}};Js.Center.SendSMS.DepartSendQuery.departSendQueryinfoPanel=new Ext.Panel({frame:true,id:"Js.Center.SendSMS.DepartSendQuery.departSendQueryinfoPanel",bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[selectPanel,departSendQueryinfoGrid]})};GridMain(node,Js.Center.SendSMS.DepartSendQuery.departSendQueryinfoPanel,"openroomiconinfo","Js.Center.SendSMS.DepartSendQuery.Infostore");Js.Center.SendSMS.DepartSendQuery.print=function(ID){var row=Js.Center.SendSMS.DepartSendQuery.Infostore.getById(ID);if(row.get("numstate")==5){Js.Center.SendSMS.DepartSendDetailsInfo.func(row)}else{Ext.Msg.alert("温馨提示","对不起，只能查看发送完成的信息！")}};Js.Center.SendSMS.DepartSendQuery.showPause=function(ID){var row=Js.Center.SendSMS.DepartSendQuery.Infostore.getById(ID);Js.Center.SendSMS.operatesms.func(row);Js.Center.SendSMS.operatesms.window.updateRecord=row;Js.Center.SendSMS.operatesms.window.show();};Js.Center.SendSMS.DepartSendQuery.doPause=function(ID,type){var row=Js.Center.SendSMS.DepartSendQuery.Infostore.getById(ID);var info="您确定要暂停此条短信吗?";if(0==type){info="您确定要继续此条短信吗?"}Ext.Msg.confirm("提示!",info,function(btn){if(btn=="yes"){Ext.MessageBox.show({msg:'正在暂停，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var params={flag:"doplausesendsms",numcontentid:ID};doAjaxWithCallBack(Js.Center.SendSMS.YXTSendContentURL,params,function(){});sendSMSCallBack()}})};function sendSMSCallBack(){Js.Center.SendSMS.DepartSendQuery.Infostore.reload({params:{start:0,limit:_pageSize},callback:function(records,options,success){selectPanel.getForm().reset();}})}};Ext.namespace('Js.Center.SendSMS.operatesms');Ext.QuickTips.init();Js.Center.SendSMS.operatesms.func=function(row){var productCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"numprodid",hiddenName:"numprodid",emptyText:"-=请选择=-",allowBlank:false,blankText:"通道组",fieldLabel:"<font>通道组</font>",disabled:true,mode:"local",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:Js.Center.Common.ProductStore});Js.Center.Common.ProductStore.reload();var doCombox=new WXTL.Widgets.CommonForm.ComboBox({xtype:"xComboBox",name:"vc2Plause",fieldLabel:"<font color=red>操作类型</font>",hiddenName:"vc2Plause",mode:"local",allowBlank:false,emptyText:'-=请选择=-',blankText:"操作类型不允许为空",displayField:"vc2name",valueField:"numprodid",triggerAction:"all",store:new Ext.data.SimpleStore({fields:["vc2name","numprodid"],data:[["直接驳回","3"],["重新审核","0"]]})});var vc2Reason=new Ext.form.TextField({xtype:"textfield",name:"vc2reason",id:"Js.Center.SendSMS.operatesms.vc2reason",allowBlank:false,fieldLabel:"审核原因",blankText:"原因不允许为空"});var operatesmsPanel=new Ext.form.FormPanel({id:"operatesmsPanel",width:470,frame:true,labelWidth:80,defaults:{anchor:"90%"},items:[{items:[{layout:'column',items:[{columnWidth:1,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",items:[productCombox,doCombox]}]}]},{xtype:"textfield",name:"datsend",fieldLabel:"<font color=red>发送时间</font>",timeFormat:'H:i:s',disabled:true,value:Js.Center.SendSMS.operatesms.datSend},{xtype:"hidden",name:"numcontentid",fieldLabel:"信息编号"},{xtype:"hidden",name:"flag",value:"operateTimingSms"},{xtype:"textfield",name:"vc2creatername",fieldLabel:"发送人",disabled:true},{xtype:"textarea",name:"vc2content",fieldLabel:"短信内容",readOnly:true,width:600,height:90},vc2Reason]});Js.Center.SendSMS.operatesms.window=new WXTL.Widgets.CommonWindows.Window({title:"操作定时短信",width:500,plain:true,iconCls:"addicon",resizable:false,defaultType:"textfield",labelWidth:100,collapsible:true,closeAction:'hide',closable:true,modal:'true',buttonAlign:"center",needButtons:false,closeAction:"close",bodyStyle:"padding:10px 0 0 15px",mainForm:operatesmsPanel.getForm(),updateURL:Js.Center.SendSMS.YXTSendContentURL,displayStore:Js.Center.SendSMS.DepartSendQuery.Infostore,updateState:false,items:[operatesmsPanel],listeners:{"show":function(){var params={flag:"plause",numcontentid:row.get("numcontentid")};ajaxNoBackValue(Js.Center.SendSMS.YXTSendContentURL,params)},"close":function(){Js.Center.SendSMS.DepartSendQuery.departSendQueryinfo.sendSMSCallBack}},buttons:[new Ext.Button({text:'确定',minWidth:70,handler:function(){if(operatesmsPanel.getForm().isValid()){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);Js.Center.SendSMS.operatesms.window.mainFormSubmitFunc()}}}),new Ext.Button({text:'重置',minWidth:70,qtip:"重置数据",handler:function(){Js.Center.SendSMS.operatesms.window.mainForm.reset();Js.Center.SendSMS.operatesms.window.mainForm.loadRecord(Js.Center.SendSMS.operatesms.window.updateRecord)}}),new Ext.Button({text:'取消',minWidth:70,handler:function(){var params={flag:"doplausesendsms",numcontentid:Js.Center.SendSMS.operatesms.window.updateRecord.get("numcontentid")};ajaxNoBackValue(Js.Center.SendSMS.YXTSendContentURL,params);Js.Center.SendSMS.operatesms.window.close()}})]});function ajaxNoBackValue(url,params){Ext.Ajax.request({url:url,method:"POST",params:params,success:function(form,action){Js.Center.SendSMS.DepartSendQuery.Infostore.reload();Js.Center.SendSMS.operatesms.window.mainForm.loadRecord(Js.Center.SendSMS.operatesms.window.updateRecord)}})}};Ext.namespace('Js.Center.SendSMS');Js.Center.SendSMS.SendQueryURL='URL/sendSMS/SendQuery/YXTSendQuery.ashx';Js.Center.SendSMS.SmsContentURL='URL/SendSMS/Send/SMSContentQuery.ashx';Js.Center.SendSMS.YXTSendContentURL='URL/SendSMS/Send/YXTSMSContentQuery.ashx';