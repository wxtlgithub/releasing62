Ext.namespace('Js.Center.Message');Js.Center.Message.messageInfo=function(node){if(Ext.get("Js.Center.Message.MessagePanel")==null){Js.Center.Common.MessageTypeStore.reload();messageUpdate=function(){var row=Ext.getCmp("messageGridPanel").getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("提示信息","您没有选中任何行!")}else if(row.length>1){Ext.Msg.alert("提示信息","对不起只能选择一个!")}else if(row.length==1){Js.Center.Message.MessageUpdate.func(row[0])}};messagedelete=function(){var row=Ext.getCmp("messageGridPanel").getSelectionModel().getSelections();if(row.length==0){Ext.Msg.alert("提示信息","请您至少选择一个!")}else{Ext.Msg.confirm("提示!","您确定要删除信息吗?",function(btn){if(btn=="yes"){Js.Center.Message.MessageDelete.func(row)}else{}})}};var _pageSize=12;var fields=["numcontentseqid","vc2title","vc2content","datcreatetime","suserid","ruserid","nummessagetypeid","vc2messagetypename","numtypeflag","vc2messagetypeurl","numstatus","datreadtime"];Js.Center.Message.Infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.Message.MessageQueryURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:fields,root:"data",id:"numcontentseqid",totalProperty:"totalCount"}),sortInfo:{field:'datcreatetime',direction:'DESC'},baseParams:{ruserid:'1',flag:'getmessagebywhere'}});Js.Center.Message.Infostore.load({params:{start:0,limit:_pageSize,ruserid:'1',flag:'getmessagebywhere'}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numcontentseqid"});var cm=new Ext.grid.ColumnModel([sm,{header:"标题",tooltip:"标题",dataIndex:"vc2title",sortable:true,renderer:function(value,meta,record,rowIndex,colIndex,store){return"<a href='#' onclick='messageUpdate()'>"+value+"</a>　"}},{header:"消息类型",tooltip:"消息类型",dataIndex:"vc2messagetypename",sortable:true},{header:"发送人",tooltip:"发送人",dataIndex:"suserid",sortable:true},{header:"状态",tooltip:"状态",dataIndex:"numstatus",sortable:true,renderer:function(value){if(value==1){return"已读"}if(value==0){return"未读"}}},{header:"发送时间",tooltip:"发送时间",dataIndex:"datcreatetime",sortable:true}]);var MessageGrid=new WXTL.Widgets.CommonGrid.GridPanel({id:"messageGridPanel",anchor:'100% 100%',pageSize:_pageSize,needMenu:false,store:Js.Center.Message.Infostore,afterEditURL:Js.Center.Message.MessageUpdateURL,deleteMethod:'Js.Center.Message.MessageDelete.func',sm:sm,cm:cm,listeners:{"rowcontextmenu":function(grid,rowIndex,e){e.stopEvent();openRightClick.showAt(e.getXY())},"afteredit":function(e){this.afterEdit(e)}},tbar:new Ext.Toolbar({items:[{text:"删除",iconCls:"deleteicon",handler:messagedelete}]})});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({id:"Js.Center.Message.SelectPanel",height:150,queryMethod:"Js.Center.Message.queryGrid",items:[{layout:'column',items:[{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{fieldLabel:'消息标题',name:'vc2title',id:'vc2title_id',regex:WXTL.Common.regex.Illegal,regexText:WXTL.Common.regexText.IllegalText,msgTarget:"side",maxLength:20},{xtype:"combo",name:"status",fieldLabel:"消息状态",hiddenName:"status",readOnly:true,mode:"local",displayField:"show",valueField:"value",triggerAction:"all",emptyText:"请选择",value:'-1',store:new Ext.data.SimpleStore({fields:["show","value"],data:[["请选择","-1"],["已读","1"],["未读","0"]]})}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:'90%',msgTarget:"side"},items:[{xtype:"xComboBox",name:"nummessagetypeid",fieldLabel:"消息类型",hiddenName:"nummessagetypeid_ext",readOnly:true,mode:"local",displayField:"vc2messagetypename",valueField:"nummessagetypeid",triggerAction:"all",store:Js.Center.Common.MessageTypeStore}]}]}]});Js.Center.Message.queryGrid=function(){if(selectPanel.getForm().isValid()){var _messagetitle=Ext.get("vc2title_id").getValue();var _messagetype=Ext.get("nummessagetypeid_ext").getValue();var _status=Ext.get("status").getValue();var flag='getmessagebywhere';Js.Center.Message.Infostore.baseParams={messagetitle:_messagetitle,messagetype:_messagetype,ruserid:'1',status:_status,flag:flag};Js.Center.Message.Infostore.load({params:{start:0,limit:_pageSize}})}};Js.Center.Message.MessagePanel=new Ext.Panel({frame:true,id:"Js.Center.Message.MessagePanel",bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[selectPanel,MessageGrid]})};GridMain(node,Js.Center.Message.MessagePanel,"openroomiconinfo","Js.Center.Message.Infostore")};Ext.namespace('Js.Center.Message.MessageUpdate');Js.Center.Message.MessageUpdate.func=function(row){var updateMessagemfp=new Ext.form.FormPanel({frame:true,labelWidth:60,items:[{layout:'form',defaults:{anchor:'90%',msgTarget:"side"},items:[{xtype:"hidden",name:"flag",value:"updateall"},{xtype:"hidden",name:"numcontentseqid",fieldLabel:"消息ID"},{xtype:"textfield",name:"vc2title",fieldLabel:"<font color=red>标题</font>",readOnly:true},{xtype:"textarea",name:"vc2content",fieldLabel:"<font color=red>内容</font>",height:200,readOnly:true}]}]});var mainForm=updateMessagemfp.getForm();Js.Center.Message.MessageUpdate.UpdateMessagemWin=new WXTL.Widgets.CommonWindows.Window({title:"查看消息",mainForm:mainForm,updateURL:Js.Center.Message.MessageUpdateURL,displayStore:Js.Center.Message.Infostore,updateState:true,updateRecord:row,items:[updateMessagemfp],needButtons:false,buttons:[{text:"关 闭",minWidth:70,handler:function(){Js.Center.Message.MessageUpdate.UpdateMessagemWin.close()}}]});if(row.get("numstatus")=='0'){var params={messageid:row.get("numcontentseqid"),status:'1',flag:"setread"};doAjax_inner(Js.Center.Message.MessageUpdateURL,params,Js.Center.Message.Infostore)};Js.Center.Message.MessageUpdate.UpdateMessagemWin.show()};function doAjax_inner(url,params,store){Ext.Ajax.request({url:url,method:"POST",params:params,success:function(form,action){obj=Ext.util.JSON.decode(form.responseText);var falg=obj.success;if(falg==true){if(store!=null)store.reload()}else Ext.Msg.alert('温馨提示',obj.info)},failure:function(form,action){var objJson=Ext.util.JSON.decode(action.response.responseText)}})};Ext.namespace('Js.Center.Message.MessageDelete');Js.Center.Message.MessageDelete.func=function(row){var deleteSplit="";for(var i=0;i<row.length;i++){if(row.length==1){deleteSplit=row[i].data.numcontentseqid}else{if(i<(row.length-1)){deleteSplit=row[i].data.numcontentseqid+","+deleteSplit}if(i==(row.length-1)){deleteSplit=deleteSplit+row[i].data.numcontentseqid}}};var params={ids:deleteSplit,flag:"deletemessage"};doAjax(Js.Center.Message.MessageUpdateURL,params,Js.Center.Message.Infostore)};