Ext.namespace('Js.Center.SendSMS.FirstCheck');Js.Center.SendSMS.FirstCheck.info=function(node){if(Ext.get("Js.Center.SendSMS.FirstCheck.MainPanel")==null){var _pageSize=12;Js.Center.SendSMS.FirstCheck.infostore=new WXTL.Widgets.CommonData.GroupingStore({proxy:new Ext.data.HttpProxy({url:Js.Center.SendSMS.SmsContentURL,method:"POST"}),reader:new Ext.data.JsonReader({fields:["numcontentid","vc2content","datsend","vc2status","numstate","numstatus","vc2numstatus","nummessageformat","numsendmethod","numpriority","vc2detail","numcheck","vc2reason","datcreate","numcreaterid","datpresend","numcheck1id","datcheck1","numcheck2id","datcheck2","numprenum","numprodid","numsource","numsendtype","vc2typelist","numstatename","numsendtypename","nummessageformatname","numtotal","numsuccess","numfailed"],root:"data",id:"numlogid",totalProperty:"totalCount"}),sortInfo:{field:'datcreate',direction:'DESC'},baseParams:{flag:'selectbykey',state:"0",numsendtype:"1,2,3,4,5,6,7,9",vc2content:''}});Js.Center.SendSMS.FirstCheck.infostore.reload({params:{start:0,limit:_pageSize},callback:function(records,options,success){firstCheckDoView(0);}});var sm=new Ext.grid.CheckboxSelectionModel({dataIndex:"numcolumnid"});var cm=new Ext.grid.ColumnModel([{header:"短信内容",tooltip:"短信内容",dataIndex:"vc2content",sortable:true},{header:"发送类型",tooltip:"发送类型",dataIndex:"numsendtypename",sortable:true},{header:"发送时间",tooltip:"发送时间",dataIndex:"datsend",sortable:true},{header:"处理状态",tooltip:"处理状态",dataIndex:"vc2numstatus",sortable:true},{header:"审核状态",tooltip:"审核状态",dataIndex:"numstatename",sortable:true},{header:"内容类型",tooltip:"内容类型",dataIndex:"nummessageformatname",sortable:true},{header:"创建时间",tooltip:"创建时间",dataIndex:"datcreate",sortable:true},{header:"操作",tooltip:"操作",dataIndex:"numsvcid",width:80,renderer:function(value,meta,record,rowIndex,colIndex,store){return"　<a href='#' onclick='firstCheckDoView(\""+rowIndex+"\")'>查看</a>"}},{header:"<font color='green'>合法</font>/<font color='red'>非法</font>",tooltip:"合法/非法",dataIndex:"numcontentid",width:100,renderer:function(value,meta,record,rowIndex,colIndex,store){var row=Js.Center.SendSMS.FirstCheck.infostore.getAt(rowIndex);var suc="<font color='green'>"+row.get("numsuccess")+"</font>";var fail="/<font color='red'>"+row.get("numfailed")+"</font>";if(row.get("numsendtype")!=2){suc=row.get("numsuccess")>0?"<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+value+"&flag=selectexport&successtype=1\")'><font color='green'>"+row.get("numsuccess")+"</font></a>":"<font color='green'>"+row.get("numsuccess")+"</font>";fail=row.get("numfailed")>0?"/<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+value+"&flag=selectexport&successtype=0\")'><font color='red'>"+row.get("numfailed")+"</font></a>":"/<font color='red'>"+row.get("numfailed")+"</font>";}else{suc="<font color='green'>"+row.get("numtotal")+"</font>"}return suc+fail}}]);var gridPanel=new WXTL.Widgets.CommonGrid.GridPanel({title:"短信一审列表",anchor:'100% 100%',pageSize:_pageSize,store:Js.Center.SendSMS.FirstCheck.infostore,needMenu:false,sm:sm,cm:cm,needRightMenu:false,listeners:{"rowclick":function(grid,rowindex,e){firstCheckDoView(rowindex)}}});var selectPanel=new WXTL.Widgets.CommonPanel.QueryFormPanel({title:"信息审核",labelWidth:80,needButtons:false,height:180,collapsed:false,queryMethod:"Js.Center.SendSMS.FirstCheck.queryGrid",items:[{layout:'column',items:[{xtype:"hidden",name:"numcontentid",id:"Js.Center.SendSMS.FirstCheck.NumContentID"},{xtype:"hidden",name:"flag",id:"Js.Center.SendSMS.FirstCheck.Flag",value:"firstcheck"},{xtype:"hidden",name:"numstatus",id:"Js.Center.SendSMS.FirstCheck.numstatus",value:""},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[{xtype:'textarea',name:'vc2content',id:"Js.Center.SendSMS.FirstCheck.vc2Content",fieldLabel:'信息内容',readOnly:true,allowBlank:false,blankText:"请选择审核信息"}]},{columnWidth:.5,layout:'form',defaultType:"textfield",defaults:{anchor:"90%",msgTarget:"side"},buttonAlign:"center",bodyStyle:"padding:10px 0 10px 15px",items:[{xtype:'textarea',name:'vc2reason',id:"Js.Center.SendSMS.FirstCheck.Reason",fieldLabel:'审核建议',allowBlank:false,blankText:"请填写审核建议",value:"通过",regex:WXTL.Common.regex.IllegalDiy,regexText:WXTL.Common.regexText.IllegalText,maxLength:200,maxLengthText:'长度应小于等于200',validator:function(){var word=Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value;if(isExistsHtmlLable(word)){return false}else{return true}},invalidText:'帧文字不能包含HTML标签'}]},{columnWidth:1,layout:'form',defaults:{anchor:"95%",msgTarget:"side"},bodyStyle:"padding:0px 0 10px 15px",items:[{html:"<div id='Js.Center.SendSMS.FirstCheck.MobileListInfo'></div>"}]}]}],buttons:[new Ext.Button({text:'通过',handler:function(){if(selectPanel.getForm().isValid()){Ext.get("Js.Center.SendSMS.FirstCheck.Flag").dom.value="firstcheck";if(Ext.get("Js.Center.SendSMS.FirstCheck.numstatus").dom.value==1){Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var params={flag:"firstcheck",vc2reason:Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value,numcontentid:Ext.get("Js.Center.SendSMS.FirstCheck.NumContentID").dom.value,vc2content:Ext.get("Js.Center.SendSMS.FirstCheck.vc2Content").dom.value};doAjaxWithCallBack(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.FirstCheck.callBackFunc)}else{Ext.Msg.alert('温馨提示','只能审核通过处理完成状态的数据！')}}}}),new Ext.Button({text:'驳回',handler:function(){if(Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value.replace(/[ ]/g,"")=="通过"){Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value=""}if(selectPanel.getForm().isValid()){Ext.get("Js.Center.SendSMS.FirstCheck.Flag").dom.value="rejectcheckbyfirst";Ext.MessageBox.show({msg:'正在保存，请稍等...',progressText:'Saving...',width:300,wait:true,icon:'download',animEl:'saving'});setTimeout(function(){Ext.MessageBox.hide()},300000);var params={flag:"rejectcheckbyfirst",vc2reason:Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value,numcontentid:Ext.get("Js.Center.SendSMS.FirstCheck.NumContentID").dom.value,vc2content:Ext.get("Js.Center.SendSMS.FirstCheck.vc2Content").dom.value};doAjaxWithCallBack(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.FirstCheck.callBackFunc)}}})]});Js.Center.SendSMS.FirstCheck.queryGrid=function(){var columnName=Ext.get("columnname").getValue();var flag='selectbykey';Js.Center.SendSMS.FirstCheck.infostore.baseParams={columnname:columnName,state:"0"};Js.Center.SendSMS.FirstCheck.infostore.reload()};Js.Center.SendSMS.FirstCheck.MainPanel=new Ext.Panel({id:"Js.Center.SendSMS.FirstCheck.MainPanel",frame:true,bodyBorder:false,border:false,autoScroll:true,layout:"anchor",defaults:{collapsible:true},items:[selectPanel,gridPanel]})}GridMain(node,Js.Center.SendSMS.FirstCheck.MainPanel,"openroomiconinfo","Js.Center.SendSMS.FirstCheck.infostore","firstDoView()")};Js.Center.SendSMS.FirstCheck.callBackFunc=function(){Js.Center.SendSMS.FirstCheck.infostore.reload({params:{start:0,limit:12},callback:function(records,options,success){Js.Center.SendSMS.FirstCheck.MainPanel.items.items[0].getForm().reset();firstCheckDoView(0)}})};function firstDoView(){Js.Center.SendSMS.FirstCheck.infostore.reload({params:{start:0,limit:12},callback:function(records,options,success){firstCheckDoView(0)}})};function firstCheckDoView(rowIndex){if(Js.Center.SendSMS.FirstCheck.infostore.getCount()>0){var row=Js.Center.SendSMS.FirstCheck.infostore.getAt(rowIndex);var sucRate;var mobileTotalInfo="总数<font color='green'>"+row.get("numtotal")+"个</font>";var mobileSucInfo="合法数<font color='green'>"+row.get("numsuccess")+"个</font>";var mobileFailInfo="非法数<font color='green'>"+row.get("numfailed")+"个</font>";if(row.get("numtotal")!=""&&row.get("numtotal")!=0){sucRate=row.get("numsuccess")/row.get("numtotal")*10000/100}else{sucRate=0}if(sucRate.toString().length>5){sucRate=sucRate.toString().substring(0,5)}Ext.get("Js.Center.SendSMS.FirstCheck.Reason").dom.value="通过";Ext.get("Js.Center.SendSMS.FirstCheck.NumContentID").dom.value=row.get("numcontentid");Ext.get("Js.Center.SendSMS.FirstCheck.vc2Content").dom.value=row.get("vc2content");Ext.get("Js.Center.SendSMS.FirstCheck.numstatus").dom.value=row.get("numstatus");if(row.get("numsendtype")!=2){if(row.get("numtotal")>0){mobileTotalInfo="总数<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+row.get("numcontentid")+"&flag=selectexport&successtype=-1\")'><font color='green'>"+row.get("numtotal")+"个</font></a> "}if(row.get("numsuccess")>0){mobileSucInfo="合法数<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+row.get("numcontentid")+"&flag=selectexport&successtype=1\")'><font color='green'>"+row.get("numsuccess")+"个</font></a> "}if(row.get("numfailed")>0){mobileFailInfo="非法数<a href='#' onclick='exportData(\""+Js.Center.SendSMS.SmsContentURL+"\",\"id="+row.get("numcontentid")+"&flag=selectexport&successtype=0\")'><font color='green'>"+row.get("numfailed")+"个</font></a> "}}else{if(row.get("numtotal")>0){mobileTotalInfo="总数<font color='green'>"+row.get("numtotal")+"个</font>";mobileSucInfo="合法数<font color='green'>"+row.get("numtotal")+"个</font> "}if(row.get("numfailed")>0){mobileFailInfo="非法数<font color='green'>"+row.get("numfailed")+"个</font> "}sucRate=100}Ext.get("Js.Center.SendSMS.FirstCheck.MobileListInfo").dom.innerHTML="号码分布情况："+mobileTotalInfo+"，"+mobileSucInfo+"，"+mobileFailInfo+"，"+"合法率<font color='red'>"+sucRate+"%</font>"}};function firstCheckDoPass(id){var params={flag:"firstcheck",numcontentid:id};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.FirstCheck.infostore)};function firstCheckDoReject(id,vc2reason){var params={flag:"rejectcheckbyfirst",numcontentid:id,vc2reason:vc2reason};doAjax(Js.Center.SendSMS.SmsContentUpdateURL,params,Js.Center.SendSMS.FirstCheck.infostore)};Ext.namespace('Js.Center.SendSMS');Js.Center.SendSMS.SmsContentURL='URL/SendSMS/Send/SMSContentQuery.ashx';Js.Center.SendSMS.SmsContentUpdateURL='URL/sendSMS/send/smscontentupdate.ashx';Js.Center.SendSMS.sendbycustomerURL='URL/GJAddressBook/Query.ashx';